import{bh as pe,i as _e,u as ve,r as b,c as ye,ae as ge,l as be,b as L,d as e,w as l,B as he,F as q,o as g,aM as Ve,q as O,j as _,g as o,aK as I,I as x,V as W,n as k,bj as xe,z as E,f as Z,x as ke,A as Ce,t as i,aN as De,ax as we,C as Pe,aw as ee}from"./index-C8qJZh3t.js";import{V as Fe}from"./VContainer-2-0rrONB.js";import{V as m,a as t}from"./VRow-Dn9b0oRF.js";import{V as Ie}from"./VForm-BlFBd7Va.js";import{a as Ee}from"./VSelect-DgfWkUOG.js";import{V as Se}from"./VAutocomplete-Bc7ghOyV.js";import{a as le,V}from"./VChip-ITK86iW2.js";import{V as ae,a as te,b as se,c as ne}from"./VExpansionPanels-YaJVnHoc.js";import{a as w,c as P}from"./VList-iFByo_wy.js";import{V as S}from"./VDivider-D0oZJiQU.js";import"./VCheckboxBtn-BvI0AomN.js";import"./filter-F5wbJB7i.js";const Me=_("h2",null,"臨打報名系統",-1),ze=_("h4",{class:"title-search py-4 text-grey-darken-3"}," 搜尋篩選 ",-1),$e={class:"region"},Ae={class:"venue"},Ne=_("h3",{class:"title-session ps-5 pt-5"}," 場次清單 ",-1),Be={style:{"font-size":"15px",color:"#FF1744"}},Te=_("br",null,null,-1),Ue={style:{"font-size":"14px",color:"#FF1744"}},Ze={__name:"signup",setup(Re){const{api:G,apiAuth:K}=Pe(),F=pe(),v=_e(),oe=ve(),ue=["台北市","新北市","桃園市","台中市","台南市","高雄市","基隆市","新竹市","嘉義市","新竹縣","苗栗縣","彰化縣","南投縣","雲林縣","嘉義縣","屏東縣","宜蘭縣","花蓮縣","台東縣","澎湖縣","金門縣","連江縣"],M=b(!1),h=b([]),z=b({}),H=b([]),d=b({city:"",venueId:"",date:"",netheight:[],level:[]}),$=b(!1),A=b([]),r=b({open:!1,session:null,male:0,female:0,nopreference:0}),J=n=>{if(D(n)){v({text:"此場次名額已滿",snackbarProps:{color:"red-lighten-1"}});return}r.value={open:!0,session:n,male:0,female:0,nopreference:0,maleDisabled:n.male===0,femaleDisabled:n.female===0,nopreferenceDisabled:n.nopreference===0}},re=(n,s,a,u)=>{const c=n+s+a,p=u.male-(u.participantMale||0),f=u.female-(u.participantFemale||0),y=u.nopreference-(u.participantNoPreference||0),j=p+f+y;return c>j?!1:a>0?a<=y:n<=p&&s<=f},de=async n=>{try{const{data:s}=await K.get(`/enrollment/check/${n}`);return s.enrolled}catch(s){throw console.error("Error checking enrollment:",s),s}},ie=async()=>{if(!oe.token){v({text:"請先登錄",snackbarProps:{color:"red-lighten-1"}}),F.push("/loginregister");return}const n=r.value.maleDisabled?0:parseInt(r.value.male)||0,s=r.value.femaleDisabled?0:parseInt(r.value.female)||0,a=r.value.nopreferenceDisabled?0:parseInt(r.value.nopreference)||0,u=r.value.session;if(n+s+a===0){v({text:"請至少報名一人",snackbarProps:{color:"red-lighten-1"}});return}if(!re(n,s,a,u)){v({text:`報名人數超過可報名人數，當前剩餘: ${T(u)}`,snackbarProps:{color:"red-lighten-1"}});return}try{if(await de(u._id)){v({text:'您已報名過該場次，點擊此處查看"報名紀錄"',snackbarProps:{color:"orange-darken-3",timeout:3e3,closeOnClick:!1,onClick:()=>{F.push("/member/enrollment")}}}),N();return}const f=(await K.post("/enrollment",{s_id:u._id,male:n,female:s,nopreference:a})).data.result.session,y=h.value.findIndex(j=>j._id===f._id);y!==-1&&(h.value[y]={...h.value[y],...f}),N(),v({text:"報名成功",snackbarProps:{color:"teal-darken-1"}}),await C(),F.push("/member/enrollment")}catch(c){console.error("Enrollment error:",c);let p="報名失敗";c.response&&c.response.data&&c.response.data.message?p=c.response.data.message:c.message&&(p=c.message),v({text:p,snackbarProps:{color:"red-lighten-1"}})}},N=()=>{r.value.open=!1},C=async()=>{var n,s;try{const a={};d.value.date&&(a.date=d.value.date);const{data:u}=await G.get("/session",{params:a});if(Array.isArray(u.result)){h.value=u.result.sort((p,f)=>new Date(p.date)-new Date(f.date));const c=[...new Set(h.value.map(p=>p.v_id.$oid))];await Promise.all(c.map(Q))}else v({text:"接收到的資料格式不正確",snackbarProps:{color:"red-lighten-1"}})}catch(a){v({text:((s=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:s.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},Q=async()=>{var n,s;try{let a=[],u=1,c=!0;for(;c;){const{data:f}=await G.get("/venue",{params:{page:u,itemsPerPage:100}});Array.isArray(f.result.data)&&f.result.data.length>0?(a=a.concat(f.result.data),u++):c=!1,f.result.total&&a.length>=f.result.total&&(c=!1)}const p=a.map(f=>({id:f._id.$oid||f._id,name:f.name,city:ce(f.address)}));z.value=p.reduce((f,y)=>(f[y.id]=y,f),{}),H.value=p}catch(a){console.error("Error loading venues:",a),v({text:((s=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:s.message)||"無法加載球場資料",snackbarProps:{color:"red-lighten-1"}})}},ce=n=>{const a=n.replace(/^\d{3,5}\s*/,"").match(/^(.+?[市縣])/);return a?a[1]:"未知地區"},X=n=>{var a;const s=n._id||n;return((a=z.value[s])==null?void 0:a.name)||"未知場地"},Y=n=>{var a;const s=n._id||n;return((a=z.value[s])==null?void 0:a.city)||"未知地區"},B=n=>new Date(n).toLocaleDateString("zh-TW"),T=n=>{const s=n.male-(n.participantMale||0),a=n.female-(n.participantFemale||0),u=n.nopreference-(n.participantNoPreference||0);if(s===0&&a===0&&u===0)return"名額已滿";if(u>0)return`不限${u}人`;{const c=[];return s>0&&c.push(`男${s}人`),a>0&&c.push(`女${a}人`),c.join(" ")}},U=async()=>{$.value=!0,await C(),A.value=h.value.filter(n=>{let s=!0;return d.value.city&&Y(n.v_id)!==d.value.city&&(s=!1),s&&d.value.venueId&&(n.v_id._id||n.v_id)!==d.value.venueId&&(s=!1),s&&d.value.date&&new Date(n.date).toISOString().split("T")[0]!==d.value.date&&(s=!1),s&&d.value.netheight.length&&(d.value.netheight.includes(n.netheight)||(s=!1)),s&&d.value.level&&d.value.level.length&&(d.value.level.some(u=>u===n.level)||(s=!1)),s}).sort((n,s)=>new Date(n.date)-new Date(s.date))},fe=async()=>{d.value={city:"",venueId:"",date:"",netheight:[],level:[]},$.value=!1,await C(),A.value=[]},R=ye(()=>($.value?A.value:h.value).sort((s,a)=>new Date(s.date)-new Date(a.date))),me=n=>{U()},D=n=>{const s=n.male-(n.participantMale||0),a=n.female-(n.participantFemale||0),u=n.nopreference-(n.participantNoPreference||0);return s<=0&&a<=0&&u<=0};return ge(()=>{F.currentRoute.value.path==="/member/enrollment"&&(M.value=!0)}),be(async()=>{M.value?(await C(),M.value=!1):(C(),Q())}),(n,s)=>(g(),L(q,null,[e(Fe,{fluid:"",style:{"max-width":"1200px","margin-top":"32px"},class:"mb-14"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"12",class:"ps-5 pb-10 text-grey-darken-1"},{default:l(()=>[Me]),_:1}),e(t,{cols:"12",md:"3",class:"py-0 px-4"},{default:l(()=>[e(Ie,{onSubmit:Ve(U,["prevent"])},{default:l(()=>[e(O,{class:"pa-4 card-search",elevation:"4"},{default:l(()=>[e(m,{"no-gutters":""},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[ze]),_:1}),e(t,{cols:"12"},{default:l(()=>[_("div",$e,[o(" 地區: "),e(Ee,{modelValue:d.value.city,"onUpdate:modelValue":s[0]||(s[0]=a=>d.value.city=a),variant:"outlined",density:"compact",items:ue,clearable:""},null,8,["modelValue"])])]),_:1}),e(t,{cols:"12"},{default:l(()=>[_("div",Ae,[o(" 球場: "),e(Se,{modelValue:d.value.venueId,"onUpdate:modelValue":s[1]||(s[1]=a=>d.value.venueId=a),items:H.value,"item-title":"name","item-value":"id",variant:"outlined",density:"compact",clearable:"",onChange:me},null,8,["modelValue","items"])])]),_:1}),e(t,{cols:"12",class:"mt-4"},{default:l(()=>[_("div",null,[o(" 日期: "),e(I,{modelValue:d.value.date,"onUpdate:modelValue":s[2]||(s[2]=a=>d.value.date=a),type:"date",density:"compact",variant:"outlined"},null,8,["modelValue"])])]),_:1}),e(t,{cols:"12",class:"mt-4"},{default:l(()=>[_("div",null,[o(" 網高: "),e(le,{modelValue:d.value.netheight,"onUpdate:modelValue":s[3]||(s[3]=a=>d.value.netheight=a),filter:"",color:"primary",variant:"outlined",multiple:""},{default:l(()=>[e(V,{label:"",value:"男網"},{default:l(()=>[o(" 男網 ")]),_:1}),e(V,{label:"",value:"女網"},{default:l(()=>[o(" 女網 ")]),_:1})]),_:1},8,["modelValue"])])]),_:1}),e(t,{cols:"12",class:"mt-4"},{default:l(()=>[_("div",null,[o(" 程度: "),e(le,{modelValue:d.value.level,"onUpdate:modelValue":s[4]||(s[4]=a=>d.value.level=a),filter:"",color:"primary",column:"",variant:"outlined",multiple:""},{default:l(()=>[e(V,{label:"",value:"C"},{default:l(()=>[o(" C ")]),_:1}),e(V,{label:"",value:"B"},{default:l(()=>[o(" B ")]),_:1}),e(V,{label:"",value:"B+"},{default:l(()=>[o(" B+ ")]),_:1}),e(V,{label:"",value:"A"},{default:l(()=>[o(" A ")]),_:1}),e(V,{label:"",value:"新手友善"},{default:l(()=>[o(" 新手友善 ")]),_:1})]),_:1},8,["modelValue"])])]),_:1}),e(t,{cols:"12",class:"my-4"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"2"},{default:l(()=>[e(x,{block:"",color:"blue-grey-darken-1",class:"mt-2",onClick:fe},{default:l(()=>[e(W,{icon:"mdi-arrow-u-left-top"})]),_:1})]),_:1}),e(t,null,{default:l(()=>[e(x,{block:"",color:"primary",class:"mt-2",onClick:U},{default:l(()=>[o(" 搜尋 ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(t,{cols:"12",md:"9"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"12",class:"py-0 px-4 pt-4 pt-md-0 px-md-0"},{default:l(()=>[e(O,{class:"pa-md-8",elevation:"4"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[Ne]),_:1}),e(t,null,{default:l(()=>[R.value.length===0?(g(),k(xe,{key:0,class:"text-center pb-10"},{default:l(()=>[o(" 未搜尋到相關場次 ")]),_:1})):E("",!0),e(ae,{class:"d-none d-md-block"},{default:l(()=>[(g(!0),L(q,null,Z(R.value,(a,u)=>(g(),k(te,{key:a._id,elevation:"0",style:ee({backgroundColor:u%2===0?"#f0f0f080":"#ECEFF1"})},{default:l(()=>[e(se,null,{default:l(()=>[e(m,{class:"text-center"},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(m,{align:"center",justify:"center"},{default:l(()=>[e(t,{cols:"4",sm:""},{default:l(()=>[o(" 會員編號 ")]),_:1}),e(t,{cols:"4",sm:""},{default:l(()=>[o(" 地區 ")]),_:1}),e(t,{cols:"4",sm:""},{default:l(()=>[o(" 球場 ")]),_:1}),e(t,{cols:"3",sm:"2"},{default:l(()=>[o(" 日期 ")]),_:1}),e(t,{cols:"3",sm:""},{default:l(()=>[o(" 時段 ")]),_:1}),e(t,{cols:"3",sm:""},{default:l(()=>[o(" 網高 ")]),_:1}),e(t,{cols:"3",sm:""},{default:l(()=>[o(" 程度 ")]),_:1})]),_:1})]),_:1}),e(t,{class:"pe-sm-6"},{default:l(()=>[e(S)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(m,{style:{"line-height":"32px","font-size":"14px"},class:"text-blue-grey-darken-3"},{default:l(()=>[e(t,{cols:"4",sm:""},{default:l(()=>[o(i(a.userId.userId),1)]),_:2},1024),e(t,{cols:"4",sm:""},{default:l(()=>[o(i(Y(a.v_id)),1)]),_:2},1024),e(t,{cols:"4",sm:""},{default:l(()=>[o(i(X(a.v_id)),1)]),_:2},1024),e(t,{cols:"3",sm:"2"},{default:l(()=>[o(i(B(a.date)),1)]),_:2},1024),e(t,{cols:"3",sm:""},{default:l(()=>[o(i(a.time),1)]),_:2},1024),e(t,{cols:"3",sm:""},{default:l(()=>[o(i(a.netheight),1)]),_:2},1024),e(t,{cols:"3",sm:""},{default:l(()=>[o(i(a.level),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(ne,null,{default:l(()=>[e(m,{class:"pa-4 ps-0 text-center",style:{"font-size":"15px"}},{default:l(()=>[e(t,{cols:"9"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"4",sm:"2"},{default:l(()=>[o(" 價錢 ")]),_:1}),e(t,{cols:"4",sm:"2"},{default:l(()=>[o(" 備註 ")]),_:1}),e(t,{cols:"3"},{default:l(()=>[o(" 報名狀態 ")]),_:1})]),_:1})]),_:1}),e(t,{cols:"12",sm:"7"},{default:l(()=>[e(S)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(m,{class:"text-blue-grey-darken-3",style:{"font-size":"14px"}},{default:l(()=>[e(t,{cols:"4",sm:"2"},{default:l(()=>[o(i(a.fee===0?"免費":`$${a.fee}/人`),1)]),_:2},1024),e(t,{cols:"4",sm:"2"},{default:l(()=>[o(i(a.note||"無備註"),1)]),_:2},1024),e(t,{cols:"3"},{default:l(()=>[o(" 尚需: "),_("span",Be,i(T(a)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(t,{cols:"12",sm:"3",class:"d-flex align-center"},{default:l(()=>[e(x,{size:"large",block:"",elevation:"0",color:"yellow-darken-4",disabled:D(a),onClick:c=>J(a)},{default:l(()=>[o(i(D(a)?"名額已滿":"我要報名")+" ",1),e(W,{icon:"mdi-playlist-check",class:"ms-2"})]),_:2},1032,["disabled","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}),e(ae,{class:"d-md-none"},{default:l(()=>[(g(!0),L(q,null,Z(R.value,(a,u)=>(g(),k(te,{key:a._id,elevation:"0",style:ee({backgroundColor:u%2===0?"#f0f0f080":"#ECEFF1"})},{default:l(()=>[e(se,null,{default:l(()=>[e(m,{class:"text-center"},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(m,{align:"center",justify:"center"},{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[o(" 球場 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[o(" 日期 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[o(" 時段 ")]),_:1})]),_:1})]),_:1}),e(t,{class:"pe-sm-6"},{default:l(()=>[e(S)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(m,{style:{"line-height":"32px","font-size":"14px"},class:"text-blue-grey-darken-3"},{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[o(i(X(a.v_id)),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[o(i(B(a.date)),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[o(i(a.time),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(ne,null,{default:l(()=>[e(m,{class:"pa-4 ps-0 text-center",style:{"font-size":"15px"}},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"12",class:"pe-4"},{default:l(()=>[e(m,null,{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[o(" 網高 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[o(" 價錢 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[o(" 報名狀態 ")]),_:1})]),_:1})]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(S)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(m,{class:"text-blue-grey-darken-3",style:{"font-size":"14px"}},{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[o(i(a.netheight),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[o(i(a.fee===0?"免費":`$${a.fee}/人`),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[o(" 尚需: "),Te,_("span",Ue,i(T(a)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(t,{cols:"12",class:"d-flex align-center"},{default:l(()=>[e(x,{size:"large",block:"",elevation:"0",color:"yellow-darken-4",disabled:D(a),onClick:c=>J(a)},{default:l(()=>[o(i(D(a)?"名額已滿":"我要報名")+" ",1),e(W,{icon:"mdi-playlist-check",class:"ms-2"})]),_:2},1032,["disabled","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(he,{modelValue:r.value.open,"onUpdate:modelValue":s[8]||(s[8]=a=>r.value.open=a),"max-width":"400px"},{default:l(()=>[e(O,{class:"px-4 py-5"},{default:l(()=>[e(ke,null,{default:l(()=>[o("報名場次")]),_:1}),e(Ce,{class:"pa-0"},{default:l(()=>[e(w,null,{default:l(()=>[e(P,null,{default:l(()=>{var a;return[o("球場："+i((a=r.value.session)==null?void 0:a.v_id.name),1)]}),_:1})]),_:1}),e(w,null,{default:l(()=>[e(P,null,{default:l(()=>{var a;return[o("日期："+i(B((a=r.value.session)==null?void 0:a.date)),1)]}),_:1})]),_:1}),e(w,null,{default:l(()=>[e(P,null,{default:l(()=>{var a;return[o("時段："+i((a=r.value.session)==null?void 0:a.time),1)]}),_:1})]),_:1}),e(w,{class:"d-md-none"},{default:l(()=>[e(P,null,{default:l(()=>{var a;return[o("程度："+i((a=r.value.session)==null?void 0:a.level),1)]}),_:1})]),_:1}),e(w,{class:"d-md-none"},{default:l(()=>[e(P,null,{default:l(()=>{var a;return[o("備註："+i(((a=r.value.session)==null?void 0:a.note)||"無備註"),1)]}),_:1})]),_:1}),r.value.maleDisabled?E("",!0):(g(),k(I,{key:0,modelValue:r.value.male,"onUpdate:modelValue":s[5]||(s[5]=a=>r.value.male=a),label:"男生人數",class:"px-3 pt-4",variant:"outlined",density:"compact",type:"number","hide-details":"",min:"0",disabled:r.value.maleDisabled},null,8,["modelValue","disabled"])),r.value.femaleDisabled?E("",!0):(g(),k(I,{key:1,modelValue:r.value.female,"onUpdate:modelValue":s[6]||(s[6]=a=>r.value.female=a),label:"女生人數",class:"px-3 pt-4",variant:"outlined",density:"compact",type:"number","hide-details":"",min:"0",disabled:r.value.femaleDisabled},null,8,["modelValue","disabled"])),r.value.nopreferenceDisabled?E("",!0):(g(),k(I,{key:2,modelValue:r.value.nopreference,"onUpdate:modelValue":s[7]||(s[7]=a=>r.value.nopreference=a),label:"不限性別人數",class:"px-3 pt-4",variant:"outlined",density:"compact",type:"number","hide-details":"",min:"0",disabled:r.value.nopreferenceDisabled},null,8,["modelValue","disabled"]))]),_:1}),e(De,null,{default:l(()=>[e(we),e(x,{color:"red-lighten-1",variant:"outlined",onClick:N},{default:l(()=>[o(" 取消 ")]),_:1}),e(x,{color:"teal-darken-1",variant:"outlined",onClick:ie},{default:l(()=>[o(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};export{Ze as default};
