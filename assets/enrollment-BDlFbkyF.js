import{_ as ne,k as re,i as de,r as $,l as ue,b as E,d as e,w as a,B as R,F,o as c,e as N,n as f,g as o,bj as W,z as p,f as G,q as V,x as H,A as J,t as u,aK as S,aN as O,ax as Q,I as _,C as ce,aw as X,V as b,p as ie,h as fe,j as A}from"./index-BPEKQBz9.js";import{b as Y}from"./route-block-B_A1xBdJ.js";import{V as i,a as s}from"./VRow-S_mgH1nz.js";import{V as Z}from"./VDivider-DhFrjR1v.js";const I=x=>(ie("data-v-5480d8ec"),x=x(),fe(),x),pe=I(()=>A("h3",{class:"opacity-90 mb-4"}," 報名紀錄 ",-1)),_e=I(()=>A("br",null,null,-1)),me=I(()=>A("br",null,null,-1)),ee={__name:"enrollment",setup(x){const{mdAndUp:C}=re(),{api:ae,apiAuth:D}=ce(),v=de(),y=$([]),n=$({open:!1,id:null,male:0,female:0,nopreference:0}),g=$({open:!1,id:null}),M=t=>!t||!t.v_id?"未知場地":t.v_id.name||"未知場地",U=t=>t?new Date(t).toLocaleDateString("zh-TW"):"未知日期",z=async()=>{var t,r;try{const{data:l}=await D.get("/enrollment");if(Array.isArray(l.result))y.value=l.result,console.log("Loaded enrollments:",y.value);else throw console.error("Unexpected data format:",l),new Error("資料格式錯誤")}catch(l){console.error("Error loading enrollments:",l),v({text:((r=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:r.message)||l.message||"無法加載報名資料",snackbarProps:{color:"red-lighten-1"}})}},B=t=>{const r=[];return t.male>0&&r.push(`男${t.male}人`),t.female>0&&r.push(`女${t.female}人`),t.nopreference>0&&r.push(`不限${t.nopreference}人`),r.join(" ")},P=t=>{n.value={open:!0,id:t._id,male:t.male||0,female:t.female||0,nopreference:t.nopreference||0,originalMale:t.male||0,originalFemale:t.female||0,originalNopreference:t.nopreference||0,session:t.s_id,showMale:t.s_id.male>0,showFemale:t.s_id.female>0,showNopreference:t.s_id.nopreference>0,enrollment:t}},T=()=>{n.value.open=!1},le=async()=>{try{const t=n.value.showMale?parseInt(n.value.male):0,r=n.value.showFemale?parseInt(n.value.female):0,l=n.value.showNopreference?parseInt(n.value.nopreference):0,k=n.value.originalMale,d=n.value.originalFemale,h=n.value.originalNopreference,m=n.value.session,q=t-k,K=r-d,oe=l-h;if(m.nopreference>0){if(q+K+oe>m.nopreference)throw new Error(`超過可用名額。當前剩餘 ${m.nopreference} 個名額。`)}else if(q>m.male||K>m.female)throw new Error(`超過可用名額。當前剩餘男 ${m.male} 名，女 ${m.female} 名。`);const w={};n.value.showMale&&(w.male=t),n.value.showFemale&&(w.female=r),n.value.showNopreference&&(w.nopreference=l),await D.patch(`/enrollment/${n.value.id}`,w),v({text:"報名更新成功",snackbarProps:{color:"teal-darken-1"}}),T(),z()}catch(t){v({text:(t==null?void 0:t.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}},j=t=>{g.value={open:!0,id:t}},L=()=>{g.value.open=!1},te=async()=>{var t,r;try{const{data:l}=await ae.get("/session");Array.isArray(l.result)?console.log("Sessions reloaded:",l.result):console.error("Unexpected data format:",l)}catch(l){console.error("Error loading sessions:",l),v({text:((r=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:r.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},se=async()=>{var t,r;try{const l=await D.delete(`/enrollment/${g.value.id}`);console.log("Delete response:",l.data),v({text:"報名刪除成功",snackbarProps:{color:"teal-darken-1"}}),L(),await z(),await te()}catch(l){console.error("Delete error:",l),v({text:((r=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:r.message)||l.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}};return ue(()=>{z()}),(t,r)=>(c(),E(F,null,[e(i,{class:"mt-4"},{default:a(()=>[e(s,{cols:"12",class:"pt-0"},{default:a(()=>[e(i,null,{default:a(()=>[e(s,{cols:"12",sm:"3"},{default:a(()=>[pe]),_:1})]),_:1})]),_:1}),e(s,{class:"pt-0 pb-2"},{default:a(()=>[e(Z)]),_:1}),N(C)?(c(),f(s,{key:0,cols:"12"},{default:a(()=>[e(i,{class:"mb-4"},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(i,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:a(()=>[e(s,{cols:"2"},{default:a(()=>[o(" 球場 ")]),_:1}),e(s,{cols:"2"},{default:a(()=>[o(" 日期 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 時段 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 網高 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 程度 ")]),_:1}),e(s,{cols:"2"},{default:a(()=>[o(" 報名人數 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 費用 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 備註 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 操作 ")]),_:1})]),_:1})]),_:1}),e(s,null,{default:a(()=>[y.value.length===0?(c(),f(W,{key:0,class:"opacity-80 text-center"},{default:a(()=>[o(" 目前您沒有報名任何場次 ")]),_:1})):p("",!0)]),_:1})]),_:1}),(c(!0),E(F,null,G(y.value,(l,k)=>(c(),f(V,{key:l._id,elevation:"0",class:"pa-4 py-8 post-card",style:X({backgroundColor:k%2===0?"#ECEFF1":"#f0f0f080"})},{default:a(()=>[e(i,null,{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(i,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:a(()=>[e(s,{cols:"2"},{default:a(()=>[o(u(M(l.s_id)),1)]),_:2},1024),e(s,{cols:"2"},{default:a(()=>{var d;return[o(u(U((d=l.s_id)==null?void 0:d.date)),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(u(((d=l.s_id)==null?void 0:d.time)||"未知時段"),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(u(((d=l.s_id)==null?void 0:d.netheight)||"未知網高"),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(u(((d=l.s_id)==null?void 0:d.level)||"未知程度"),1)]}),_:2},1024),e(s,{cols:"2"},{default:a(()=>[o(u(B(l)),1)]),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(u(((d=l.s_id)==null?void 0:d.fee)===0?"免費":`$${l.s_id.fee}/人`),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(u(((d=l.s_id)==null?void 0:d.note)||"無"),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>[e(_,{size:"small",color:"teal-darken-1",variant:"outlined",onClick:d=>P(l)},{default:a(()=>[e(b,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),e(_,{size:"small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:d=>j(l._id)},{default:a(()=>[e(b,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})):p("",!0),N(C)?p("",!0):(c(),f(s,{key:1,cols:"12"},{default:a(()=>[e(i,{class:"mb-4"},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(i,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:a(()=>[e(s,null,{default:a(()=>[o(" 球場 ")]),_:1}),e(s,null,{default:a(()=>[o(" 日期/時段 ")]),_:1}),e(s,{cols:"3"},{default:a(()=>[o(" 操作 ")]),_:1})]),_:1})]),_:1})]),_:1}),y.value.length===0?(c(),f(W,{key:0,align:"center",class:"opacity-80"},{default:a(()=>[o(" 目前您沒有報名任何場次 ")]),_:1})):p("",!0),(c(!0),E(F,null,G(y.value,(l,k)=>(c(),f(V,{key:l._id,elevation:"0",class:"pa-4 py-8 post-card",style:X({backgroundColor:k%2===0?"#ECEFF1":"#f0f0f080"})},{default:a(()=>[e(i,null,{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(i,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:a(()=>[e(s,null,{default:a(()=>[o(u(M(l.s_id)),1)]),_:2},1024),e(s,null,{default:a(()=>{var d,h;return[o(u(U((d=l.s_id)==null?void 0:d.date))+" ",1),_e,o(" "+u(((h=l.s_id)==null?void 0:h.time)||"未知時段"),1)]}),_:2},1024),e(s,{cols:"3"},{default:a(()=>[e(_,{size:"x-small",color:"teal-darken-1",variant:"outlined",onClick:d=>P(l)},{default:a(()=>[e(b,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),me,e(_,{size:"x-small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:d=>j(l._id)},{default:a(()=>[e(b,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}))]),_:1}),e(R,{modelValue:n.value.open,"onUpdate:modelValue":r[3]||(r[3]=l=>n.value.open=l),"max-width":"320px"},{default:a(()=>[e(V,{class:"px-2 py-5 rounded-lg"},{default:a(()=>[e(H,{class:"ps-6",style:{"font-size":"16px"}},{default:a(()=>[o(" 編輯報名 ")]),_:1}),e(J,null,{default:a(()=>[N(C)?p("",!0):(c(),f(i,{key:0,class:"mb-4 md-down-dialog-text"},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 網高: "+u(((l=n.value.session)==null?void 0:l.netheight)||"未知"),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 程度: "+u(((l=n.value.session)==null?void 0:l.level)||"未知"),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 價錢: "+u(((l=n.value.session)==null?void 0:l.fee)===0?"免費":`$${n.value.session.fee}/人`),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 備註: "+u(((l=n.value.session)==null?void 0:l.note)||"無"),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>[o(" 你已報名: "+u(B(n.value.enrollment)),1)]),_:1}),e(Z,{class:"mt-2 mb-5"})]),_:1})),n.value.showMale?(c(),f(S,{key:1,modelValue:n.value.male,"onUpdate:modelValue":r[0]||(r[0]=l=>n.value.male=l),label:"男生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):p("",!0),n.value.showFemale?(c(),f(S,{key:2,modelValue:n.value.female,"onUpdate:modelValue":r[1]||(r[1]=l=>n.value.female=l),label:"女生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):p("",!0),n.value.showNopreference?(c(),f(S,{key:3,modelValue:n.value.nopreference,"onUpdate:modelValue":r[2]||(r[2]=l=>n.value.nopreference=l),label:"不限性別人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):p("",!0)]),_:1}),e(O,{class:"px-5"},{default:a(()=>[e(Q),e(_,{color:"red-darken-1",variant:"outlined",size:"small",onClick:T},{default:a(()=>[o(" 取消 ")]),_:1}),e(_,{color:"teal-lighten-1",variant:"outlined",size:"small",onClick:le},{default:a(()=>[o(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(R,{modelValue:g.value.open,"onUpdate:modelValue":r[4]||(r[4]=l=>g.value.open=l),"max-width":"300px"},{default:a(()=>[e(V,{class:"py-4 px-3"},{default:a(()=>[e(H,{style:{"font-size":"16px"}},{default:a(()=>[o(" 取消確認 ")]),_:1}),e(J,{style:{"font-size":"15px"}},{default:a(()=>[o(" 確定要取消報名嗎？ ")]),_:1}),e(O,null,{default:a(()=>[e(Q),e(_,{color:"blue-grey-darken-1",variant:"outlined",size:"small",text:"",onClick:L},{default:a(()=>[o(" 取消 ")]),_:1}),e(_,{color:"red-darken-3",variant:"outlined",size:"small",text:"",onClick:se},{default:a(()=>[o(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};typeof Y=="function"&&Y(ee);const xe=ne(ee,[["__scopeId","data-v-5480d8ec"]]);export{xe as default};
