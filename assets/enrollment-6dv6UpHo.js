import{_ as ce,k as ie,i as ue,r as F,l as fe,o as i,b as T,d as a,w as l,B as q,F as N,e as M,n as m,g as n,bj as K,z as g,f as W,q as C,x as G,A as J,t as c,aK as P,aN as Q,ax as X,I as _,C as pe,aw as Y,V as b,p as me,h as _e,j as D}from"./index-D4JXaTkU.js";import{b as Z}from"./route-block-B_A1xBdJ.js";import{V as f,a as o}from"./VRow-D8ucyM63.js";import{V as ee}from"./VDivider-D21NWlRn.js";const I=V=>(me("data-v-89bbb4cf"),V=V(),_e(),V),ve=I(()=>D("h3",{class:"opacity-90 mb-4"}," 報名紀錄 ",-1)),ge=I(()=>D("br",null,null,-1)),ke=I(()=>D("br",null,null,-1)),we=I(()=>D("br",null,null,-1)),ae={__name:"enrollment",setup(V){const{mdAndUp:S}=ie(),{api:le,apiAuth:E}=pe(),w=ue(),y=F([]),d=F({open:!1,id:null,male:0,female:0,nopreference:0}),x=F({open:!1,id:null}),z=t=>!t||!t.v_id?"未知場地":t.v_id.name||"未知場地",R=t=>t?new Date(t).toLocaleDateString("zh-TW"):"未知日期",U=async()=>{var t,s;try{const{data:e}=await E.get("/enrollment");if(Array.isArray(e.result))y.value=e.result,console.log("Loaded enrollments:",y.value);else throw console.error("Unexpected data format:",e),new Error("資料格式錯誤")}catch(e){console.error("Error loading enrollments:",e),w({text:((s=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"無法加載報名資料",snackbarProps:{color:"red-lighten-1"}})}},B=t=>{const s=[];return t.male>0&&s.push(`男${t.male}人`),t.female>0&&s.push(`女${t.female}人`),t.nopreference>0&&s.push(`不限${t.nopreference}人`),s.join(" ")},L=t=>{d.value={open:!0,id:t._id,male:t.male||0,female:t.female||0,nopreference:t.nopreference||0,originalMale:t.male||0,originalFemale:t.female||0,originalNopreference:t.nopreference||0,session:t.s_id,showMale:t.s_id.male>0,showFemale:t.s_id.female>0,showNopreference:t.s_id.nopreference>0,enrollment:t}},O=()=>{d.value.open=!1},te=async()=>{try{const t=d.value.showMale?parseInt(d.value.male):0,s=d.value.showFemale?parseInt(d.value.female):0,e=d.value.showNopreference?parseInt(d.value.nopreference):0,v=d.value.originalMale,r=d.value.originalFemale,p=d.value.originalNopreference,u=d.value.session,h=t-v,k=s-r,A=e-p;if(u.nopreference>0){if(h+k+A>u.nopreference)throw new Error(`超過可用名額。當前剩餘 ${u.nopreference} 個名額。`)}else if(h>u.male||k>u.female)throw new Error(`超過可用名額。當前剩餘男 ${u.male} 名，女 ${u.female} 名。`);const $={};d.value.showMale&&($.male=t),d.value.showFemale&&($.female=s),d.value.showNopreference&&($.nopreference=e),await E.patch(`/enrollment/${d.value.id}`,$),w({text:"報名更新成功",snackbarProps:{color:"teal-darken-1"}}),O(),U()}catch(t){w({text:(t==null?void 0:t.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}},j=t=>{x.value={open:!0,id:t}},H=()=>{x.value.open=!1},oe=async()=>{var t,s;try{const{data:e}=await le.get("/session");Array.isArray(e.result)?console.log("Sessions reloaded:",e.result):console.error("Unexpected data format:",e)}catch(e){console.error("Error loading sessions:",e),w({text:((s=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:s.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},se=async()=>{var t,s;try{const e=await E.delete(`/enrollment/${x.value.id}`);console.log("Delete response:",e.data),w({text:"報名刪除成功",snackbarProps:{color:"teal-darken-1"}}),H(),await U(),await oe()}catch(e){console.error("Delete error:",e),w({text:((s=(t=e==null?void 0:e.response)==null?void 0:t.data)==null?void 0:s.message)||e.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},ne=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,de=/Android/.test(navigator.userAgent),re=t=>{const s=t.s_id,e=z(s),[v,r]=s.time.split("-"),p=new Date(s.date);p.setHours(parseInt(v.split(":")[0]),parseInt(v.split(":")[1]));const u=new Date(s.date);u.setHours(parseInt(r.split(":")[0]),parseInt(r.split(":")[1]));const h=`網高: ${s.netheight}
程度: ${s.level}
費用: ${s.fee}/人
備註: ${s.note||"無"}`;let k;ne?k=`calshow:/${p.getTime()}`:de?k=`content://com.android.calendar/time/${p.getTime()}`:k=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`排球場次 - ${e}`)}&dates=${p.toISOString().replace(/-|:|\.\d\d\d/g,"")}/${u.toISOString().replace(/-|:|\.\d\d\d/g,"")}&details=${encodeURIComponent(h)}&location=${encodeURIComponent(e)}`,window.location.href=k,setTimeout(()=>{if(!document.hidden){const A=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`排球場次 - ${e}`)}&dates=${p.toISOString().replace(/-|:|\.\d\d\d/g,"")}/${u.toISOString().replace(/-|:|\.\d\d\d/g,"")}&details=${encodeURIComponent(h)}&location=${encodeURIComponent(e)}`;window.open(A,"_blank")}},1e3)};return fe(()=>{U()}),(t,s)=>(i(),T(N,null,[a(f,{class:"mt-4"},{default:l(()=>[a(o,{cols:"12",class:"pt-0"},{default:l(()=>[a(f,null,{default:l(()=>[a(o,{cols:"12",sm:"3"},{default:l(()=>[ve]),_:1})]),_:1})]),_:1}),a(o,{class:"pt-0 pb-2"},{default:l(()=>[a(ee)]),_:1}),M(S)?(i(),m(o,{key:0,cols:"12"},{default:l(()=>[a(f,{class:"mb-4"},{default:l(()=>[a(o,{cols:"12"},{default:l(()=>[a(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:l(()=>[a(o,{cols:"2"},{default:l(()=>[n(" 球場 ")]),_:1}),a(o,{cols:"2"},{default:l(()=>[n(" 日期 ")]),_:1}),a(o,{cols:"1"},{default:l(()=>[n(" 時段 ")]),_:1}),a(o,{cols:"1"},{default:l(()=>[n(" 網高 ")]),_:1}),a(o,{cols:"1"},{default:l(()=>[n(" 程度 ")]),_:1}),a(o,{cols:"2"},{default:l(()=>[n(" 報名人數 ")]),_:1}),a(o,{cols:"1"},{default:l(()=>[n(" 費用 ")]),_:1}),a(o,{cols:"1"},{default:l(()=>[n(" 備註 ")]),_:1}),a(o,{cols:"1"},{default:l(()=>[n(" 操作 ")]),_:1})]),_:1})]),_:1}),a(o,null,{default:l(()=>[y.value.length===0?(i(),m(K,{key:0,class:"opacity-80 text-center"},{default:l(()=>[n(" 目前您沒有報名任何場次 ")]),_:1})):g("",!0)]),_:1})]),_:1}),(i(!0),T(N,null,W(y.value,(e,v)=>(i(),m(C,{key:e._id,elevation:"0",class:"pa-4 py-8 post-card",style:Y({backgroundColor:v%2===0?"#ECEFF1":"#f0f0f080"})},{default:l(()=>[a(f,null,{default:l(()=>[a(o,{cols:"12"},{default:l(()=>[a(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:l(()=>[a(o,{cols:"2"},{default:l(()=>[n(c(z(e.s_id)),1)]),_:2},1024),a(o,{cols:"2"},{default:l(()=>{var r;return[n(c(R((r=e.s_id)==null?void 0:r.date)),1)]}),_:2},1024),a(o,{cols:"1"},{default:l(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.time)||"未知時段"),1)]}),_:2},1024),a(o,{cols:"1"},{default:l(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.netheight)||"未知網高"),1)]}),_:2},1024),a(o,{cols:"1"},{default:l(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.level)||"未知程度"),1)]}),_:2},1024),a(o,{cols:"2"},{default:l(()=>[n(c(B(e)),1)]),_:2},1024),a(o,{cols:"1"},{default:l(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.fee)===0?"免費":`$${e.s_id.fee}/人`),1)]}),_:2},1024),a(o,{cols:"1"},{default:l(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.note)||"無"),1)]}),_:2},1024),a(o,{cols:"1"},{default:l(()=>[a(_,{size:"small",color:"teal-darken-1",variant:"outlined",onClick:r=>L(e)},{default:l(()=>[a(b,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),a(_,{size:"small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:r=>j(e._id)},{default:l(()=>[a(b,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})):g("",!0),M(S)?g("",!0):(i(),m(o,{key:1,cols:"12"},{default:l(()=>[a(f,{class:"mb-4"},{default:l(()=>[a(o,{cols:"12"},{default:l(()=>[a(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:l(()=>[a(o,null,{default:l(()=>[n(" 球場 ")]),_:1}),a(o,null,{default:l(()=>[n(" 日期/時段 ")]),_:1}),a(o,{cols:"3"},{default:l(()=>[n(" 操作 ")]),_:1})]),_:1})]),_:1})]),_:1}),y.value.length===0?(i(),m(K,{key:0,align:"center",class:"opacity-80"},{default:l(()=>[n(" 目前您沒有報名任何場次 ")]),_:1})):g("",!0),(i(!0),T(N,null,W(y.value,(e,v)=>(i(),m(C,{key:e._id,elevation:"0",class:"pa-4 py-8 post-card",style:Y({backgroundColor:v%2===0?"#ECEFF1":"#f0f0f080"})},{default:l(()=>[a(f,null,{default:l(()=>[a(o,{cols:"12"},{default:l(()=>[a(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:l(()=>[a(o,null,{default:l(()=>[n(c(z(e.s_id)),1)]),_:2},1024),a(o,null,{default:l(()=>{var r,p;return[n(c(R((r=e.s_id)==null?void 0:r.date))+" ",1),ge,n(" "+c(((p=e.s_id)==null?void 0:p.time)||"未知時段"),1)]}),_:2},1024),a(o,{cols:"3"},{default:l(()=>[a(_,{size:"x-small",color:"blue-darken-1",variant:"outlined",class:"mt-2",onClick:r=>re(e)},{default:l(()=>[a(b,{icon:"mdi-clock-out"})]),_:2},1032,["onClick"]),ke,a(_,{size:"x-small",color:"teal-darken-1",variant:"outlined",onClick:r=>L(e)},{default:l(()=>[a(b,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),we,a(_,{size:"x-small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:r=>j(e._id)},{default:l(()=>[a(b,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}))]),_:1}),a(q,{modelValue:d.value.open,"onUpdate:modelValue":s[3]||(s[3]=e=>d.value.open=e),"max-width":"320px"},{default:l(()=>[a(C,{class:"px-2 py-5 rounded-lg"},{default:l(()=>[a(G,{class:"ps-6",style:{"font-size":"16px"}},{default:l(()=>[n(" 編輯報名 ")]),_:1}),a(J,null,{default:l(()=>[M(S)?g("",!0):(i(),m(f,{key:0,class:"mb-4 md-down-dialog-text"},{default:l(()=>[a(o,{cols:"12"},{default:l(()=>{var e;return[n(" 網高: "+c(((e=d.value.session)==null?void 0:e.netheight)||"未知"),1)]}),_:1}),a(o,{cols:"12"},{default:l(()=>{var e;return[n(" 程度: "+c(((e=d.value.session)==null?void 0:e.level)||"未知"),1)]}),_:1}),a(o,{cols:"12"},{default:l(()=>{var e;return[n(" 價錢: "+c(((e=d.value.session)==null?void 0:e.fee)===0?"免費":`$${d.value.session.fee}/人`),1)]}),_:1}),a(o,{cols:"12"},{default:l(()=>{var e;return[n(" 備註: "+c(((e=d.value.session)==null?void 0:e.note)||"無"),1)]}),_:1}),a(o,{cols:"12"},{default:l(()=>[n(" 你已報名: "+c(B(d.value.enrollment)),1)]),_:1}),a(ee,{class:"mt-2 mb-5"})]),_:1})),d.value.showMale?(i(),m(P,{key:1,modelValue:d.value.male,"onUpdate:modelValue":s[0]||(s[0]=e=>d.value.male=e),label:"男生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):g("",!0),d.value.showFemale?(i(),m(P,{key:2,modelValue:d.value.female,"onUpdate:modelValue":s[1]||(s[1]=e=>d.value.female=e),label:"女生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):g("",!0),d.value.showNopreference?(i(),m(P,{key:3,modelValue:d.value.nopreference,"onUpdate:modelValue":s[2]||(s[2]=e=>d.value.nopreference=e),label:"不限性別人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):g("",!0)]),_:1}),a(Q,{class:"px-5"},{default:l(()=>[a(X),a(_,{color:"red-darken-1",variant:"outlined",size:"small",onClick:O},{default:l(()=>[n(" 取消 ")]),_:1}),a(_,{color:"teal-lighten-1",variant:"outlined",size:"small",onClick:te},{default:l(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(q,{modelValue:x.value.open,"onUpdate:modelValue":s[4]||(s[4]=e=>x.value.open=e),"max-width":"300px"},{default:l(()=>[a(C,{class:"py-4 px-3"},{default:l(()=>[a(G,{style:{"font-size":"16px"}},{default:l(()=>[n(" 取消確認 ")]),_:1}),a(J,{style:{"font-size":"15px"}},{default:l(()=>[n(" 確定要取消報名嗎？ ")]),_:1}),a(Q,null,{default:l(()=>[a(X),a(_,{color:"blue-grey-darken-1",variant:"outlined",size:"small",text:"",onClick:H},{default:l(()=>[n(" 取消 ")]),_:1}),a(_,{color:"red-darken-3",variant:"outlined",size:"small",text:"",onClick:se},{default:l(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};typeof Z=="function"&&Z(ae);const Ve=ce(ae,[["__scopeId","data-v-89bbb4cf"]]);export{Ve as default};
