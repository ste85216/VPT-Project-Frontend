import{bi as pe,i as _e,u as ve,r as b,af as ge,n as ye,o as g,b as R,d as e,w as l,C as be,F as T,aN as he,s as L,h as p,g as n,aL as S,J as C,V as j,q as V,bk as Ve,A as D,f as K,y as xe,B as ke,t as i,aO as Pe,ay as Ce,D as Ee,ax as Q}from"./index-BTtIyDGB.js";import{V as De}from"./VContainer-qXRlbguS.js";import{V as f,a as t}from"./VRow-D9VES1vB.js";import{V as we}from"./VForm-Cgc7hZUQ.js";import{a as Fe}from"./VSelect-DDD2MOOG.js";import{V as Ie}from"./VAutocomplete-CdBZpQM2.js";import{a as X,V as x}from"./VChip-9szuzcKh.js";import{V as Y,a as Z,b as ee,c as le}from"./VExpansionPanels-D3iALhu6.js";import{V as Se}from"./VPagination-DKRQ9NXy.js";import{a as w,c as F}from"./VList-BRz-Zc3g.js";import{V as U}from"./VDivider-nHE9IfsE.js";import"./VCheckboxBtn-yrcXBh_M.js";import"./filter-wOj-ZlMu.js";const Ue=p("h2",null,"臨打報名系統",-1),ze=p("h4",{class:"title-search py-4 text-grey-darken-3"}," 搜尋篩選 ",-1),Ae={class:"region"},Me={class:"venue"},Ne=p("h3",{class:"title-session ps-5 pt-5"}," 場次清單 ",-1),$e={style:{"font-size":"15px",color:"#FF1744"}},Be=p("br",null,null,-1),Re={style:{"font-size":"14px",color:"#FF1744"}},ae=10,el={__name:"signup",setup(Te){const{api:O,apiAuth:W}=Ee(),I=pe(),_=_e(),te=ve(),ne=["台北市","新北市","桃園市","台中市","台南市","高雄市","基隆市","新竹市","嘉義市","新竹縣","苗栗縣","彰化縣","南投縣","雲林縣","嘉義縣","屏東縣","宜蘭縣","花蓮縣","台東縣","澎湖縣","金門縣","連江縣"],oe=b(!1),h=b([]),z=b({}),q=b([]),u=b({city:"",venueId:"",date:"",netheight:[],level:[]}),k=b(1),A=b(1),d=b({open:!1,session:null,male:0,female:0,nopreference:0}),P=async()=>{var o,s;try{const a=new URLSearchParams;a.append("itemsPerPage",ae),a.append("page",k.value),u.value.date&&a.append("date",u.value.date),u.value.city&&a.append("city",u.value.city),u.value.venueId&&a.append("venueId",u.value.venueId),u.value.netheight.forEach(c=>a.append("netheight",c)),u.value.level.forEach(c=>a.append("level",c));const{data:r}=await O.get("/session",{params:a});r.success?(h.value=r.result.data,A.value=r.result.totalPages):_({text:"接收到的資料格式不正確",snackbarProps:{color:"red-lighten-1"}})}catch(a){_({text:((s=(o=a==null?void 0:a.response)==null?void 0:o.data)==null?void 0:s.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},E=o=>{const s=o.male-(o.participantMale||0),a=o.female-(o.participantFemale||0),r=o.nopreference-(o.participantNoPreference||0);return s<=0&&a<=0&&r<=0},se=async()=>{var o,s;try{let a=[],r=1,c=!0;for(;c;){const{data:m}=await O.get("/venue",{params:{page:r,itemsPerPage:100}});Array.isArray(m.result.data)&&m.result.data.length>0?(a=a.concat(m.result.data),r++):c=!1,m.result.total&&a.length>=m.result.total&&(c=!1)}const v=a.map(m=>({id:m._id.$oid||m._id,name:m.name,city:ue(m.address)}));z.value=v.reduce((m,y)=>(m[y.id]=y,m),{}),q.value=v}catch(a){console.error("Error loading venues:",a),_({text:((s=(o=a==null?void 0:a.response)==null?void 0:o.data)==null?void 0:s.message)||"無法加載球場資料",snackbarProps:{color:"red-lighten-1"}})}},ue=o=>{const a=o.replace(/^\d{3,5}\s*/,"").match(/^(.+?[市縣])/);return a?a[1]:"未知地區"},G=o=>{var a;const s=o._id||o;return((a=z.value[s])==null?void 0:a.name)||"未知場地"},de=o=>{var a;const s=o._id||o;return((a=z.value[s])==null?void 0:a.city)||"未知地區"},re=()=>{P()},J=o=>{if(E(o)){_({text:"此場次名額已滿",snackbarProps:{color:"red-lighten-1"}});return}d.value={open:!0,session:o,male:0,female:0,nopreference:0,maleDisabled:o.male===0,femaleDisabled:o.female===0,nopreferenceDisabled:o.nopreference===0}},ce=(o,s,a,r)=>{const c=o+s+a,v=r.male-(r.participantMale||0),m=r.female-(r.participantFemale||0),y=r.nopreference-(r.participantNoPreference||0),B=v+m+y;return c>B?!1:a>0?a<=y:o<=v&&s<=m},ie=async o=>{try{const{data:s}=await W.get(`/enrollment/check/${o}`);return s.enrolled}catch(s){throw console.error("Error checking enrollment:",s),s}},fe=async()=>{if(!te.token){_({text:"請先登錄",snackbarProps:{color:"red-lighten-1"}}),I.push("/loginregister");return}const o=d.value.maleDisabled?0:parseInt(d.value.male)||0,s=d.value.femaleDisabled?0:parseInt(d.value.female)||0,a=d.value.nopreferenceDisabled?0:parseInt(d.value.nopreference)||0,r=d.value.session;if(o+s+a===0){_({text:"請至少報名一人",snackbarProps:{color:"red-lighten-1"}});return}if(!ce(o,s,a,r)){_({text:`報名人數超過可報名人數，當前剩餘: ${$(r)}`,snackbarProps:{color:"red-lighten-1"}});return}try{if(await ie(r._id)){_({text:'您已報名過該場次，點擊此處查看"報名紀錄"',snackbarProps:{color:"orange-darken-3",timeout:2e3,closeOnClick:!1,onClick:()=>{I.push("/member/enrollment")},style:{cursor:"pointer"}}}),M();return}const m=(await W.post("/enrollment",{s_id:r._id,male:o,female:s,nopreference:a})).data.result.session,y=h.value.findIndex(B=>B._id===m._id);y!==-1&&(h.value[y]={...h.value[y],...m}),M(),_({text:"報名成功",snackbarProps:{color:"teal-darken-1"}}),await P(),I.push("/member/enrollment")}catch(c){console.error("Enrollment error:",c);let v="報名失敗";c.response&&c.response.data&&c.response.data.message?v=c.response.data.message:c.message&&(v=c.message),_({text:v,snackbarProps:{color:"red-lighten-1"}})}},M=()=>{d.value.open=!1},N=o=>new Date(o).toLocaleDateString("zh-TW"),$=o=>{const s=o.male-(o.participantMale||0),a=o.female-(o.participantFemale||0),r=o.nopreference-(o.participantNoPreference||0);if(s===0&&a===0&&r===0)return"名額已滿";if(r>0)return`不限${r}人`;{const c=[];return s>0&&c.push(`男${s}人`),a>0&&c.push(`女${a}人`),c.join(" ")}},H=async()=>{k.value=1,console.log("Filters:",u.value);const o=new URLSearchParams;o.append("itemsPerPage",ae),o.append("page",k.value),u.value.date&&o.append("date",u.value.date),u.value.city&&o.append("city",u.value.city),u.value.venueId&&o.append("venueId",u.value.venueId),u.value.netheight.forEach(s=>o.append("netheight",s)),u.value.level.forEach(s=>o.append("level",s)),console.log("API Params:",o.toString()),await P()},me=()=>{u.value={city:"",venueId:"",date:"",netheight:[],level:[]},k.value=1,P()};return ge(()=>{I.currentRoute.value.path==="/member/enrollment"&&(oe.value=!0)}),ye(async()=>{await P(),await se()}),(o,s)=>(g(),R(T,null,[e(De,{fluid:"",style:{"max-width":"1200px","margin-top":"32px"},class:"mb-14"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"12",class:"ps-5 pb-10 text-grey-darken-1"},{default:l(()=>[Ue]),_:1}),e(t,{cols:"12",md:"3",class:"py-0 px-4"},{default:l(()=>[e(we,{onSubmit:he(H,["prevent"])},{default:l(()=>[e(L,{class:"pa-4 card-search",elevation:"4"},{default:l(()=>[e(f,{"no-gutters":""},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[ze]),_:1}),e(t,{cols:"12"},{default:l(()=>[p("div",Ae,[n(" 地區: "),e(Fe,{modelValue:u.value.city,"onUpdate:modelValue":s[0]||(s[0]=a=>u.value.city=a),variant:"outlined",density:"compact",items:ne,clearable:""},null,8,["modelValue"])])]),_:1}),e(t,{cols:"12"},{default:l(()=>[p("div",Me,[n(" 球場: "),e(Ie,{modelValue:u.value.venueId,"onUpdate:modelValue":s[1]||(s[1]=a=>u.value.venueId=a),items:q.value,"item-title":"name","item-value":"id",variant:"outlined",density:"compact",clearable:"",onChange:re},null,8,["modelValue","items"])])]),_:1}),e(t,{cols:"12",class:"mt-4"},{default:l(()=>[p("div",null,[n(" 日期: "),e(S,{modelValue:u.value.date,"onUpdate:modelValue":s[2]||(s[2]=a=>u.value.date=a),type:"date",density:"compact",variant:"outlined"},null,8,["modelValue"])])]),_:1}),e(t,{cols:"12",class:"mt-4"},{default:l(()=>[p("div",null,[n(" 網高: "),e(X,{modelValue:u.value.netheight,"onUpdate:modelValue":s[3]||(s[3]=a=>u.value.netheight=a),filter:"",color:"primary",variant:"outlined",multiple:""},{default:l(()=>[e(x,{label:"",value:"男網"},{default:l(()=>[n(" 男網 ")]),_:1}),e(x,{label:"",value:"女網"},{default:l(()=>[n(" 女網 ")]),_:1})]),_:1},8,["modelValue"])])]),_:1}),e(t,{cols:"12",class:"mt-4"},{default:l(()=>[p("div",null,[n(" 程度: "),e(X,{modelValue:u.value.level,"onUpdate:modelValue":s[4]||(s[4]=a=>u.value.level=a),filter:"",color:"primary",column:"",variant:"outlined",multiple:""},{default:l(()=>[e(x,{label:"",value:"C"},{default:l(()=>[n(" C ")]),_:1}),e(x,{label:"",value:"B"},{default:l(()=>[n(" B ")]),_:1}),e(x,{label:"",value:"B+"},{default:l(()=>[n(" B+ ")]),_:1}),e(x,{label:"",value:"A"},{default:l(()=>[n(" A ")]),_:1}),e(x,{label:"",value:"新手友善"},{default:l(()=>[n(" 新手友善 ")]),_:1})]),_:1},8,["modelValue"])])]),_:1}),e(t,{cols:"12",class:"my-4"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"2"},{default:l(()=>[e(C,{block:"",color:"blue-grey-darken-1",class:"mt-2",onClick:me},{default:l(()=>[e(j,{icon:"mdi-arrow-u-left-top"})]),_:1})]),_:1}),e(t,null,{default:l(()=>[e(C,{block:"",color:"primary",class:"mt-2",onClick:H},{default:l(()=>[n(" 搜尋 ")]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(t,{cols:"12",md:"9"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"12",class:"py-0 px-4 pt-4 pt-md-0 px-md-0"},{default:l(()=>[e(L,{class:"pa-md-8",elevation:"4"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[Ne]),_:1}),e(t,null,{default:l(()=>[h.value.length===0?(g(),V(Ve,{key:0,class:"text-center pb-10"},{default:l(()=>[n(" 未搜尋到相關場次 ")]),_:1})):D("",!0),e(Y,{class:"d-none d-md-block"},{default:l(()=>[(g(!0),R(T,null,K(h.value,(a,r)=>(g(),V(Z,{key:a._id,elevation:"0",style:Q({backgroundColor:r%2===0?"#f0f0f080":"#ECEFF1"})},{default:l(()=>[e(ee,null,{default:l(()=>[e(f,{class:"text-center"},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(f,{align:"center",justify:"center"},{default:l(()=>[e(t,{cols:"4",sm:""},{default:l(()=>[n(" 會員編號 ")]),_:1}),e(t,{cols:"4",sm:""},{default:l(()=>[n(" 地區 ")]),_:1}),e(t,{cols:"4",sm:""},{default:l(()=>[n(" 球場 ")]),_:1}),e(t,{cols:"3",sm:"2"},{default:l(()=>[n(" 日期 ")]),_:1}),e(t,{cols:"3",sm:""},{default:l(()=>[n(" 時段 ")]),_:1}),e(t,{cols:"3",sm:""},{default:l(()=>[n(" 網高 ")]),_:1}),e(t,{cols:"3",sm:""},{default:l(()=>[n(" 程度 ")]),_:1})]),_:1})]),_:1}),e(t,{class:"pe-sm-6"},{default:l(()=>[e(U)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(f,{style:{"line-height":"32px","font-size":"14px"},class:"text-blue-grey-darken-3"},{default:l(()=>[e(t,{cols:"4",sm:""},{default:l(()=>[n(i(a.userId.userId),1)]),_:2},1024),e(t,{cols:"4",sm:""},{default:l(()=>[n(i(de(a.v_id)),1)]),_:2},1024),e(t,{cols:"4",sm:""},{default:l(()=>[n(i(G(a.v_id)),1)]),_:2},1024),e(t,{cols:"3",sm:"2"},{default:l(()=>[n(i(N(a.date)),1)]),_:2},1024),e(t,{cols:"3",sm:""},{default:l(()=>[n(i(a.time),1)]),_:2},1024),e(t,{cols:"3",sm:""},{default:l(()=>[n(i(a.netheight),1)]),_:2},1024),e(t,{cols:"3",sm:""},{default:l(()=>[n(i(a.level),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(le,null,{default:l(()=>[e(f,{class:"pa-4 ps-0 text-center",style:{"font-size":"15px"}},{default:l(()=>[e(t,{cols:"9"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"4",sm:"2"},{default:l(()=>[n(" 價錢 ")]),_:1}),e(t,{cols:"4",sm:"2"},{default:l(()=>[n(" 備註 ")]),_:1}),e(t,{cols:"3"},{default:l(()=>[n(" 報名狀態 ")]),_:1})]),_:1})]),_:1}),e(t,{cols:"12",sm:"7"},{default:l(()=>[e(U)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(f,{class:"text-blue-grey-darken-3",style:{"font-size":"14px"}},{default:l(()=>[e(t,{cols:"4",sm:"2"},{default:l(()=>[n(i(a.fee===0?"免費":`$${a.fee}/人`),1)]),_:2},1024),e(t,{cols:"4",sm:"2"},{default:l(()=>[n(i(a.note||"無備註"),1)]),_:2},1024),e(t,{cols:"3"},{default:l(()=>[n(" 尚需: "),p("span",$e,i($(a)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(t,{cols:"12",sm:"3",class:"d-flex align-center"},{default:l(()=>[e(C,{size:"large",block:"",elevation:"0",color:"yellow-darken-4",disabled:E(a),onClick:c=>J(a)},{default:l(()=>[n(i(E(a)?"名額已滿":"我要報名")+" ",1),e(j,{icon:"mdi-playlist-check",class:"ms-2"})]),_:2},1032,["disabled","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}),e(Y,{class:"d-md-none"},{default:l(()=>[(g(!0),R(T,null,K(h.value,(a,r)=>(g(),V(Z,{key:a._id,elevation:"0",style:Q({backgroundColor:r%2===0?"#f0f0f080":"#ECEFF1"})},{default:l(()=>[e(ee,null,{default:l(()=>[e(f,{class:"text-center"},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(f,{align:"center",justify:"center"},{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[n(" 球場 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[n(" 日期 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[n(" 時段 ")]),_:1})]),_:1})]),_:1}),e(t,{class:"pe-sm-6"},{default:l(()=>[e(U)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(f,{style:{"line-height":"32px","font-size":"14px"},class:"text-blue-grey-darken-3"},{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[n(i(G(a.v_id)),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[n(i(N(a.date)),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[n(i(a.time),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(le,null,{default:l(()=>[e(f,{class:"pa-4 ps-0 text-center",style:{"font-size":"15px"}},{default:l(()=>[e(t,{cols:"12"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"12",class:"pe-4"},{default:l(()=>[e(f,null,{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[n(" 網高 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[n(" 價錢 ")]),_:1}),e(t,{cols:"4"},{default:l(()=>[n(" 報名狀態 ")]),_:1})]),_:1})]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(U)]),_:1}),e(t,{cols:"12"},{default:l(()=>[e(f,{class:"text-blue-grey-darken-3",style:{"font-size":"14px"}},{default:l(()=>[e(t,{cols:"4"},{default:l(()=>[n(i(a.netheight),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[n(i(a.fee===0?"免費":`$${a.fee}/人`),1)]),_:2},1024),e(t,{cols:"4"},{default:l(()=>[n(" 尚需: "),Be,p("span",Re,i($(a)),1)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(t,{cols:"12",class:"d-flex align-center"},{default:l(()=>[e(C,{size:"large",block:"",elevation:"0",color:"yellow-darken-4",disabled:E(a),onClick:c=>J(a)},{default:l(()=>[n(i(E(a)?"名額已滿":"我要報名")+" ",1),e(j,{icon:"mdi-playlist-check",class:"ms-2"})]),_:2},1032,["disabled","onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})]),_:1})]),_:1}),e(t,null,{default:l(()=>[A.value>1?(g(),V(Se,{key:0,modelValue:k.value,"onUpdate:modelValue":[s[5]||(s[5]=a=>k.value=a),P],length:A.value,rounded:"circle",density:"compact","next-icon":"mdi-menu-right","prev-icon":"mdi-menu-left","total-visible":8,color:"teal-darken-1"},null,8,["modelValue","length"])):D("",!0)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(be,{modelValue:d.value.open,"onUpdate:modelValue":s[9]||(s[9]=a=>d.value.open=a),"max-width":"400px"},{default:l(()=>[e(L,{class:"px-4 py-5"},{default:l(()=>[e(xe,null,{default:l(()=>[n("報名場次")]),_:1}),e(ke,{class:"pa-0"},{default:l(()=>[e(w,null,{default:l(()=>[e(F,null,{default:l(()=>{var a;return[n("球場："+i((a=d.value.session)==null?void 0:a.v_id.name),1)]}),_:1})]),_:1}),e(w,null,{default:l(()=>[e(F,null,{default:l(()=>{var a;return[n("日期："+i(N((a=d.value.session)==null?void 0:a.date)),1)]}),_:1})]),_:1}),e(w,null,{default:l(()=>[e(F,null,{default:l(()=>{var a;return[n("時段："+i((a=d.value.session)==null?void 0:a.time),1)]}),_:1})]),_:1}),e(w,{class:"d-md-none"},{default:l(()=>[e(F,null,{default:l(()=>{var a;return[n("程度："+i((a=d.value.session)==null?void 0:a.level),1)]}),_:1})]),_:1}),e(w,{class:"d-md-none"},{default:l(()=>[e(F,null,{default:l(()=>{var a;return[n("備註："+i(((a=d.value.session)==null?void 0:a.note)||"無備註"),1)]}),_:1})]),_:1}),d.value.maleDisabled?D("",!0):(g(),V(S,{key:0,modelValue:d.value.male,"onUpdate:modelValue":s[6]||(s[6]=a=>d.value.male=a),label:"男生人數",class:"px-3 pt-4",variant:"outlined",density:"compact",type:"number","hide-details":"",min:"0",disabled:d.value.maleDisabled},null,8,["modelValue","disabled"])),d.value.femaleDisabled?D("",!0):(g(),V(S,{key:1,modelValue:d.value.female,"onUpdate:modelValue":s[7]||(s[7]=a=>d.value.female=a),label:"女生人數",class:"px-3 pt-4",variant:"outlined",density:"compact",type:"number","hide-details":"",min:"0",disabled:d.value.femaleDisabled},null,8,["modelValue","disabled"])),d.value.nopreferenceDisabled?D("",!0):(g(),V(S,{key:2,modelValue:d.value.nopreference,"onUpdate:modelValue":s[8]||(s[8]=a=>d.value.nopreference=a),label:"不限性別人數",class:"px-3 pt-4",variant:"outlined",density:"compact",type:"number","hide-details":"",min:"0",disabled:d.value.nopreferenceDisabled},null,8,["modelValue","disabled"]))]),_:1}),e(Pe,null,{default:l(()=>[e(Ce),e(C,{color:"red-lighten-1",variant:"outlined",onClick:M},{default:l(()=>[n(" 取消 ")]),_:1}),e(C,{color:"teal-darken-1",variant:"outlined",onClick:fe},{default:l(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};export{el as default};
