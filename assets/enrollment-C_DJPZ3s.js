import{_ as fe,k as pe,i as me,r as A,l as _e,o as i,b as N,d as a,w as t,B as q,F as M,e as P,n as p,g as n,bj as K,z as k,f as W,q as D,x as G,A as J,t as c,aK as R,aN as Q,ax as X,I as _,C as ve,aw as Y,V as C,p as ge,h as ke,j as I}from"./index-AexevADK.js";import{b as ee}from"./route-block-B_A1xBdJ.js";import{V as f,a as o}from"./VRow-Xe-l9eDu.js";import{V as ae}from"./VDivider-Bj1fYcnR.js";const S=V=>(ge("data-v-392f0044"),V=V(),ke(),V),ye=S(()=>I("h3",{class:"opacity-90 mb-4"}," 報名紀錄 ",-1)),xe=S(()=>I("br",null,null,-1)),he=S(()=>I("br",null,null,-1)),we=S(()=>I("br",null,null,-1)),te={__name:"enrollment",setup(V){const{mdAndUp:U}=pe(),{api:le,apiAuth:z}=ve(),y=me(),h=A([]),d=A({open:!1,id:null,male:0,female:0,nopreference:0}),$=A({open:!1,id:null}),E=l=>!l||!l.v_id?"未知場地":l.v_id.name||"未知場地",B=l=>l?new Date(l).toLocaleDateString("zh-TW"):"未知日期",F=async()=>{var l,s;try{const{data:e}=await z.get("/enrollment");if(Array.isArray(e.result))h.value=e.result,console.log("Loaded enrollments:",h.value);else throw console.error("Unexpected data format:",e),new Error("資料格式錯誤")}catch(e){console.error("Error loading enrollments:",e),y({text:((s=(l=e==null?void 0:e.response)==null?void 0:l.data)==null?void 0:s.message)||e.message||"無法加載報名資料",snackbarProps:{color:"red-lighten-1"}})}},L=l=>{const s=[];return l.male>0&&s.push(`男${l.male}人`),l.female>0&&s.push(`女${l.female}人`),l.nopreference>0&&s.push(`不限${l.nopreference}人`),s.join(" ")},O=l=>{d.value={open:!0,id:l._id,male:l.male||0,female:l.female||0,nopreference:l.nopreference||0,originalMale:l.male||0,originalFemale:l.female||0,originalNopreference:l.nopreference||0,session:l.s_id,showMale:l.s_id.male>0,showFemale:l.s_id.female>0,showNopreference:l.s_id.nopreference>0,enrollment:l}},j=()=>{d.value.open=!1},oe=async()=>{try{const l=d.value.showMale?parseInt(d.value.male):0,s=d.value.showFemale?parseInt(d.value.female):0,e=d.value.showNopreference?parseInt(d.value.nopreference):0,v=d.value.originalMale,r=d.value.originalFemale,m=d.value.originalNopreference,u=d.value.session,w=l-v,x=s-r,b=e-m;if(u.nopreference>0){if(w+x+b>u.nopreference)throw new Error(`超過可用名額。當前剩餘 ${u.nopreference} 個名額。`)}else if(w>u.male||x>u.female)throw new Error(`超過可用名額。當前剩餘男 ${u.male} 名，女 ${u.female} 名。`);const g={};d.value.showMale&&(g.male=l),d.value.showFemale&&(g.female=s),d.value.showNopreference&&(g.nopreference=e),await z.patch(`/enrollment/${d.value.id}`,g),y({text:"報名更新成功",snackbarProps:{color:"teal-darken-1"}}),j(),F()}catch(l){y({text:(l==null?void 0:l.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}},H=l=>{$.value={open:!0,id:l}},Z=()=>{$.value.open=!1},se=async()=>{var l,s;try{const{data:e}=await le.get("/session");Array.isArray(e.result)?console.log("Sessions reloaded:",e.result):console.error("Unexpected data format:",e)}catch(e){console.error("Error loading sessions:",e),y({text:((s=(l=e==null?void 0:e.response)==null?void 0:l.data)==null?void 0:s.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},ne=async()=>{var l,s;try{const e=await z.delete(`/enrollment/${$.value.id}`);console.log("Delete response:",e.data),y({text:"報名刪除成功",snackbarProps:{color:"teal-darken-1"}}),Z(),await F(),await se()}catch(e){console.error("Delete error:",e),y({text:((s=(l=e==null?void 0:e.response)==null?void 0:l.data)==null?void 0:s.message)||e.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},de=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,re=/Android/.test(navigator.userAgent),ce=l=>{const s=l.s_id,e=E(s),[v,r]=s.time.split("-"),m=new Date(s.date);m.setHours(parseInt(v.split(":")[0]),parseInt(v.split(":")[1]));const u=new Date(s.date);u.setHours(parseInt(r.split(":")[0]),parseInt(r.split(":")[1]));const w=`網高: ${s.netheight}
程度: ${s.level}
費用: ${s.fee}/人
備註: ${s.note||"無"}`;let x;if(de){const b=encodeURIComponent(`排球場次 - ${e}`),g=encodeURIComponent(e),T=encodeURIComponent(w),ie=m.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",ue=u.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";x=`calshow:/?title=${b}&location=${g}&notes=${T}&startdate=${ie}&enddate=${ue}`}else if(re){const b=encodeURIComponent(`排球場次 - ${e}`),g=encodeURIComponent(e),T=encodeURIComponent(w);x=`content://com.android.calendar/events?title=${b}&description=${T}&location=${g}&beginTime=${m.getTime()}&endTime=${u.getTime()}`}else x=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`排球場次 - ${e}`)}&dates=${m.toISOString().replace(/-|:|\.\d\d\d/g,"")}/${u.toISOString().replace(/-|:|\.\d\d\d/g,"")}&details=${encodeURIComponent(w)}&location=${encodeURIComponent(e)}`;window.location.href=x,setTimeout(()=>{document.hidden||y({text:"無法自動添加到日曆。請手動添加事件。",snackbarProps:{color:"orange-darken-2"}})},1e3)};return _e(()=>{F()}),(l,s)=>(i(),N(M,null,[a(f,{class:"mt-4"},{default:t(()=>[a(o,{cols:"12",class:"pt-0"},{default:t(()=>[a(f,null,{default:t(()=>[a(o,{cols:"12",sm:"3"},{default:t(()=>[ye]),_:1})]),_:1})]),_:1}),a(o,{class:"pt-0 pb-2"},{default:t(()=>[a(ae)]),_:1}),P(U)?(i(),p(o,{key:0,cols:"12"},{default:t(()=>[a(f,{class:"mb-4"},{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:t(()=>[a(o,{cols:"2"},{default:t(()=>[n(" 球場 ")]),_:1}),a(o,{cols:"2"},{default:t(()=>[n(" 日期 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 時段 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 網高 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 程度 ")]),_:1}),a(o,{cols:"2"},{default:t(()=>[n(" 報名人數 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 費用 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 備註 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 操作 ")]),_:1})]),_:1})]),_:1}),a(o,null,{default:t(()=>[h.value.length===0?(i(),p(K,{key:0,class:"opacity-80 text-center"},{default:t(()=>[n(" 目前您沒有報名任何場次 ")]),_:1})):k("",!0)]),_:1})]),_:1}),(i(!0),N(M,null,W(h.value,(e,v)=>(i(),p(D,{key:e._id,elevation:"0",class:"pa-4 py-8 post-card",style:Y({backgroundColor:v%2===0?"#ECEFF1":"#f0f0f080"})},{default:t(()=>[a(f,null,{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:t(()=>[a(o,{cols:"2"},{default:t(()=>[n(c(E(e.s_id)),1)]),_:2},1024),a(o,{cols:"2"},{default:t(()=>{var r;return[n(c(B((r=e.s_id)==null?void 0:r.date)),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.time)||"未知時段"),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.netheight)||"未知網高"),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.level)||"未知程度"),1)]}),_:2},1024),a(o,{cols:"2"},{default:t(()=>[n(c(L(e)),1)]),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.fee)===0?"免費":`$${e.s_id.fee}/人`),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var r;return[n(c(((r=e.s_id)==null?void 0:r.note)||"無"),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>[a(_,{size:"small",color:"teal-darken-1",variant:"outlined",onClick:r=>O(e)},{default:t(()=>[a(C,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),a(_,{size:"small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:r=>H(e._id)},{default:t(()=>[a(C,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})):k("",!0),P(U)?k("",!0):(i(),p(o,{key:1,cols:"12"},{default:t(()=>[a(f,{class:"mb-4"},{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:t(()=>[a(o,null,{default:t(()=>[n(" 球場 ")]),_:1}),a(o,null,{default:t(()=>[n(" 日期/時段 ")]),_:1}),a(o,{cols:"3"},{default:t(()=>[n(" 操作 ")]),_:1})]),_:1})]),_:1})]),_:1}),h.value.length===0?(i(),p(K,{key:0,align:"center",class:"opacity-80"},{default:t(()=>[n(" 目前您沒有報名任何場次 ")]),_:1})):k("",!0),(i(!0),N(M,null,W(h.value,(e,v)=>(i(),p(D,{key:e._id,elevation:"0",class:"pa-4 py-8 post-card",style:Y({backgroundColor:v%2===0?"#ECEFF1":"#f0f0f080"})},{default:t(()=>[a(f,null,{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:t(()=>[a(o,null,{default:t(()=>[n(c(E(e.s_id)),1)]),_:2},1024),a(o,null,{default:t(()=>{var r,m;return[n(c(B((r=e.s_id)==null?void 0:r.date))+" ",1),xe,n(" "+c(((m=e.s_id)==null?void 0:m.time)||"未知時段"),1)]}),_:2},1024),a(o,{cols:"3"},{default:t(()=>[a(_,{size:"x-small",color:"blue-darken-1",variant:"outlined",class:"mt-2",onClick:r=>ce(e)},{default:t(()=>[a(C,{icon:"mdi-clock-out"})]),_:2},1032,["onClick"]),he,a(_,{size:"x-small",color:"teal-darken-1",variant:"outlined",onClick:r=>O(e)},{default:t(()=>[a(C,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),we,a(_,{size:"x-small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:r=>H(e._id)},{default:t(()=>[a(C,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}))]),_:1}),a(q,{modelValue:d.value.open,"onUpdate:modelValue":s[3]||(s[3]=e=>d.value.open=e),"max-width":"320px"},{default:t(()=>[a(D,{class:"px-2 py-5 rounded-lg"},{default:t(()=>[a(G,{class:"ps-6",style:{"font-size":"16px"}},{default:t(()=>[n(" 編輯報名 ")]),_:1}),a(J,null,{default:t(()=>[P(U)?k("",!0):(i(),p(f,{key:0,class:"mb-4 md-down-dialog-text"},{default:t(()=>[a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 網高: "+c(((e=d.value.session)==null?void 0:e.netheight)||"未知"),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 程度: "+c(((e=d.value.session)==null?void 0:e.level)||"未知"),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 價錢: "+c(((e=d.value.session)==null?void 0:e.fee)===0?"免費":`$${d.value.session.fee}/人`),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 備註: "+c(((e=d.value.session)==null?void 0:e.note)||"無"),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>[n(" 你已報名: "+c(L(d.value.enrollment)),1)]),_:1}),a(ae,{class:"mt-2 mb-5"})]),_:1})),d.value.showMale?(i(),p(R,{key:1,modelValue:d.value.male,"onUpdate:modelValue":s[0]||(s[0]=e=>d.value.male=e),label:"男生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0),d.value.showFemale?(i(),p(R,{key:2,modelValue:d.value.female,"onUpdate:modelValue":s[1]||(s[1]=e=>d.value.female=e),label:"女生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0),d.value.showNopreference?(i(),p(R,{key:3,modelValue:d.value.nopreference,"onUpdate:modelValue":s[2]||(s[2]=e=>d.value.nopreference=e),label:"不限性別人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0)]),_:1}),a(Q,{class:"px-5"},{default:t(()=>[a(X),a(_,{color:"red-darken-1",variant:"outlined",size:"small",onClick:j},{default:t(()=>[n(" 取消 ")]),_:1}),a(_,{color:"teal-lighten-1",variant:"outlined",size:"small",onClick:oe},{default:t(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(q,{modelValue:$.value.open,"onUpdate:modelValue":s[4]||(s[4]=e=>$.value.open=e),"max-width":"300px"},{default:t(()=>[a(D,{class:"py-4 px-3"},{default:t(()=>[a(G,{style:{"font-size":"16px"}},{default:t(()=>[n(" 取消確認 ")]),_:1}),a(J,{style:{"font-size":"15px"}},{default:t(()=>[n(" 確定要取消報名嗎？ ")]),_:1}),a(Q,null,{default:t(()=>[a(X),a(_,{color:"blue-grey-darken-1",variant:"outlined",size:"small",text:"",onClick:Z},{default:t(()=>[n(" 取消 ")]),_:1}),a(_,{color:"red-darken-3",variant:"outlined",size:"small",text:"",onClick:ne},{default:t(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};typeof ee=="function"&&ee(te);const De=fe(te,[["__scopeId","data-v-392f0044"]]);export{De as default};
