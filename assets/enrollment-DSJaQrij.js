import{_ as fe,k as pe,i as me,r as F,l as _e,o as u,b as M,d as a,w as t,B as X,F as N,e as P,n as m,g as n,bj as K,z as k,f as Q,q as D,x as W,A as Y,t as r,aK as R,aN as q,ax as G,I as _,C as ve,aw as J,V as C,p as ge,h as ke,j as I}from"./index-COFt97vo.js";import{b as ee}from"./route-block-B_A1xBdJ.js";import{V as f,a as o}from"./VRow-BsOBK4eB.js";import{V as ae}from"./VDivider-B4VWAb38.js";const S=V=>(ge("data-v-b20c62a2"),V=V(),ke(),V),we=S(()=>I("h3",{class:"opacity-90 mb-4"}," 報名紀錄 ",-1)),xe=S(()=>I("br",null,null,-1)),ye=S(()=>I("br",null,null,-1)),he=S(()=>I("br",null,null,-1)),te={__name:"enrollment",setup(V){const{mdAndUp:E}=pe(),{api:le,apiAuth:U}=ve(),h=me(),$=F([]),d=F({open:!1,id:null,male:0,female:0,nopreference:0}),b=F({open:!1,id:null}),T=l=>!l||!l.v_id?"未知場地":l.v_id.name||"未知場地",O=l=>l?new Date(l).toLocaleDateString("zh-TW"):"未知日期",z=async()=>{var l,s;try{const{data:e}=await U.get("/enrollment");if(Array.isArray(e.result))$.value=e.result,console.log("Loaded enrollments:",$.value);else throw console.error("Unexpected data format:",e),new Error("資料格式錯誤")}catch(e){console.error("Error loading enrollments:",e),h({text:((s=(l=e==null?void 0:e.response)==null?void 0:l.data)==null?void 0:s.message)||e.message||"無法加載報名資料",snackbarProps:{color:"red-lighten-1"}})}},B=l=>{const s=[];return l.male>0&&s.push(`男${l.male}人`),l.female>0&&s.push(`女${l.female}人`),l.nopreference>0&&s.push(`不限${l.nopreference}人`),s.join(" ")},L=l=>{d.value={open:!0,id:l._id,male:l.male||0,female:l.female||0,nopreference:l.nopreference||0,originalMale:l.male||0,originalFemale:l.female||0,originalNopreference:l.nopreference||0,session:l.s_id,showMale:l.s_id.male>0,showFemale:l.s_id.female>0,showNopreference:l.s_id.nopreference>0,enrollment:l}},Z=()=>{d.value.open=!1},oe=async()=>{try{const l=d.value.showMale?parseInt(d.value.male):0,s=d.value.showFemale?parseInt(d.value.female):0,e=d.value.showNopreference?parseInt(d.value.nopreference):0,v=d.value.originalMale,c=d.value.originalFemale,p=d.value.originalNopreference,i=d.value.session,w=l-v,x=s-c,y=e-p;if(i.nopreference>0){if(w+x+y>i.nopreference)throw new Error(`超過可用名額。當前剩餘 ${i.nopreference} 個名額。`)}else if(w>i.male||x>i.female)throw new Error(`超過可用名額。當前剩餘男 ${i.male} 名，女 ${i.female} 名。`);const g={};d.value.showMale&&(g.male=l),d.value.showFemale&&(g.female=s),d.value.showNopreference&&(g.nopreference=e),await U.patch(`/enrollment/${d.value.id}`,g),h({text:"報名更新成功",snackbarProps:{color:"teal-darken-1"}}),Z(),z()}catch(l){h({text:(l==null?void 0:l.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}},j=l=>{b.value={open:!0,id:l}},H=()=>{b.value.open=!1},se=async()=>{var l,s;try{const{data:e}=await le.get("/session");Array.isArray(e.result)?console.log("Sessions reloaded:",e.result):console.error("Unexpected data format:",e)}catch(e){console.error("Error loading sessions:",e),h({text:((s=(l=e==null?void 0:e.response)==null?void 0:l.data)==null?void 0:s.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},ne=async()=>{var l,s;try{const e=await U.delete(`/enrollment/${b.value.id}`);console.log("Delete response:",e.data),h({text:"報名刪除成功",snackbarProps:{color:"teal-darken-1"}}),H(),await z(),await se()}catch(e){console.error("Delete error:",e),h({text:((s=(l=e==null?void 0:e.response)==null?void 0:l.data)==null?void 0:s.message)||e.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},de=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,ce=/Android/.test(navigator.userAgent),re=l=>{const s=l.s_id,e=T(s),[v,c]=s.time.split("-"),p=new Date(s.date);p.setHours(parseInt(v.split(":")[0]),parseInt(v.split(":")[1]));const i=new Date(s.date);i.setHours(parseInt(c.split(":")[0]),parseInt(c.split(":")[1]));const w=`網高: ${s.netheight}
程度: ${s.level}
費用: ${s.fee}/人
備註: ${s.note||"無"}`;let x;if(de){const y=encodeURIComponent(`排球場次 - ${e}`),g=encodeURIComponent(e),A=encodeURIComponent(w),ie=p.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z",ue=i.toISOString().replace(/[-:]/g,"").split(".")[0]+"Z";x=`webcal://p39-caldav.icloud.com/published/2/MTAxMzQ0NDExOTUxMDEzNDBEhFzYbBhWlpOkdUYQXSHmT6MZs-DkoGZEKE1PPXVX6?start=${ie}&end=${ue}&title=${y}&location=${g}&description=${A}`}else if(ce){const y=encodeURIComponent(`排球場次 - ${e}`),g=encodeURIComponent(e),A=encodeURIComponent(w);x=`content://com.android.calendar/events?title=${y}&description=${A}&location=${g}&beginTime=${p.getTime()}&endTime=${i.getTime()}`}else x=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`排球場次 - ${e}`)}&dates=${p.toISOString().replace(/-|:|\.\d\d\d/g,"")}/${i.toISOString().replace(/-|:|\.\d\d\d/g,"")}&details=${encodeURIComponent(w)}&location=${encodeURIComponent(e)}`;window.location.href=x,setTimeout(()=>{if(!document.hidden){const y=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`排球場次 - ${e}`)}&dates=${p.toISOString().replace(/-|:|\.\d\d\d/g,"")}/${i.toISOString().replace(/-|:|\.\d\d\d/g,"")}&details=${encodeURIComponent(w)}&location=${encodeURIComponent(e)}`;window.open(y,"_blank")}},1e3)};return _e(()=>{z()}),(l,s)=>(u(),M(N,null,[a(f,{class:"mt-4"},{default:t(()=>[a(o,{cols:"12",class:"pt-0"},{default:t(()=>[a(f,null,{default:t(()=>[a(o,{cols:"12",sm:"3"},{default:t(()=>[we]),_:1})]),_:1})]),_:1}),a(o,{class:"pt-0 pb-2"},{default:t(()=>[a(ae)]),_:1}),P(E)?(u(),m(o,{key:0,cols:"12"},{default:t(()=>[a(f,{class:"mb-4"},{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:t(()=>[a(o,{cols:"2"},{default:t(()=>[n(" 球場 ")]),_:1}),a(o,{cols:"2"},{default:t(()=>[n(" 日期 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 時段 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 網高 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 程度 ")]),_:1}),a(o,{cols:"2"},{default:t(()=>[n(" 報名人數 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 費用 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 備註 ")]),_:1}),a(o,{cols:"1"},{default:t(()=>[n(" 操作 ")]),_:1})]),_:1})]),_:1}),a(o,null,{default:t(()=>[$.value.length===0?(u(),m(K,{key:0,class:"opacity-80 text-center"},{default:t(()=>[n(" 目前您沒有報名任何場次 ")]),_:1})):k("",!0)]),_:1})]),_:1}),(u(!0),M(N,null,Q($.value,(e,v)=>(u(),m(D,{key:e._id,elevation:"0",class:"pa-4 py-8 post-card",style:J({backgroundColor:v%2===0?"#ECEFF1":"#f0f0f080"})},{default:t(()=>[a(f,null,{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:t(()=>[a(o,{cols:"2"},{default:t(()=>[n(r(T(e.s_id)),1)]),_:2},1024),a(o,{cols:"2"},{default:t(()=>{var c;return[n(r(O((c=e.s_id)==null?void 0:c.date)),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var c;return[n(r(((c=e.s_id)==null?void 0:c.time)||"未知時段"),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var c;return[n(r(((c=e.s_id)==null?void 0:c.netheight)||"未知網高"),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var c;return[n(r(((c=e.s_id)==null?void 0:c.level)||"未知程度"),1)]}),_:2},1024),a(o,{cols:"2"},{default:t(()=>[n(r(B(e)),1)]),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var c;return[n(r(((c=e.s_id)==null?void 0:c.fee)===0?"免費":`$${e.s_id.fee}/人`),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>{var c;return[n(r(((c=e.s_id)==null?void 0:c.note)||"無"),1)]}),_:2},1024),a(o,{cols:"1"},{default:t(()=>[a(_,{size:"small",color:"teal-darken-1",variant:"outlined",onClick:c=>L(e)},{default:t(()=>[a(C,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),a(_,{size:"small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:c=>j(e._id)},{default:t(()=>[a(C,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})):k("",!0),P(E)?k("",!0):(u(),m(o,{key:1,cols:"12"},{default:t(()=>[a(f,{class:"mb-4"},{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:t(()=>[a(o,null,{default:t(()=>[n(" 球場 ")]),_:1}),a(o,null,{default:t(()=>[n(" 日期/時段 ")]),_:1}),a(o,{cols:"3"},{default:t(()=>[n(" 操作 ")]),_:1})]),_:1})]),_:1})]),_:1}),$.value.length===0?(u(),m(K,{key:0,align:"center",class:"opacity-80"},{default:t(()=>[n(" 目前您沒有報名任何場次 ")]),_:1})):k("",!0),(u(!0),M(N,null,Q($.value,(e,v)=>(u(),m(D,{key:e._id,elevation:"0",class:"pa-4 py-8 post-card",style:J({backgroundColor:v%2===0?"#ECEFF1":"#f0f0f080"})},{default:t(()=>[a(f,null,{default:t(()=>[a(o,{cols:"12"},{default:t(()=>[a(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:t(()=>[a(o,null,{default:t(()=>[n(r(T(e.s_id)),1)]),_:2},1024),a(o,null,{default:t(()=>{var c,p;return[n(r(O((c=e.s_id)==null?void 0:c.date))+" ",1),xe,n(" "+r(((p=e.s_id)==null?void 0:p.time)||"未知時段"),1)]}),_:2},1024),a(o,{cols:"3"},{default:t(()=>[a(_,{size:"x-small",color:"blue-darken-1",variant:"outlined",class:"mt-2",onClick:c=>re(e)},{default:t(()=>[a(C,{icon:"mdi-clock-out"})]),_:2},1032,["onClick"]),ye,a(_,{size:"x-small",color:"teal-darken-1",variant:"outlined",onClick:c=>L(e)},{default:t(()=>[a(C,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),he,a(_,{size:"x-small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:c=>j(e._id)},{default:t(()=>[a(C,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}))]),_:1}),a(X,{modelValue:d.value.open,"onUpdate:modelValue":s[3]||(s[3]=e=>d.value.open=e),"max-width":"320px"},{default:t(()=>[a(D,{class:"px-2 py-5 rounded-lg"},{default:t(()=>[a(W,{class:"ps-6",style:{"font-size":"16px"}},{default:t(()=>[n(" 編輯報名 ")]),_:1}),a(Y,null,{default:t(()=>[P(E)?k("",!0):(u(),m(f,{key:0,class:"mb-4 md-down-dialog-text"},{default:t(()=>[a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 網高: "+r(((e=d.value.session)==null?void 0:e.netheight)||"未知"),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 程度: "+r(((e=d.value.session)==null?void 0:e.level)||"未知"),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 價錢: "+r(((e=d.value.session)==null?void 0:e.fee)===0?"免費":`$${d.value.session.fee}/人`),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>{var e;return[n(" 備註: "+r(((e=d.value.session)==null?void 0:e.note)||"無"),1)]}),_:1}),a(o,{cols:"12"},{default:t(()=>[n(" 你已報名: "+r(B(d.value.enrollment)),1)]),_:1}),a(ae,{class:"mt-2 mb-5"})]),_:1})),d.value.showMale?(u(),m(R,{key:1,modelValue:d.value.male,"onUpdate:modelValue":s[0]||(s[0]=e=>d.value.male=e),label:"男生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0),d.value.showFemale?(u(),m(R,{key:2,modelValue:d.value.female,"onUpdate:modelValue":s[1]||(s[1]=e=>d.value.female=e),label:"女生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0),d.value.showNopreference?(u(),m(R,{key:3,modelValue:d.value.nopreference,"onUpdate:modelValue":s[2]||(s[2]=e=>d.value.nopreference=e),label:"不限性別人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0)]),_:1}),a(q,{class:"px-5"},{default:t(()=>[a(G),a(_,{color:"red-darken-1",variant:"outlined",size:"small",onClick:Z},{default:t(()=>[n(" 取消 ")]),_:1}),a(_,{color:"teal-lighten-1",variant:"outlined",size:"small",onClick:oe},{default:t(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),a(X,{modelValue:b.value.open,"onUpdate:modelValue":s[4]||(s[4]=e=>b.value.open=e),"max-width":"300px"},{default:t(()=>[a(D,{class:"py-4 px-3"},{default:t(()=>[a(W,{style:{"font-size":"16px"}},{default:t(()=>[n(" 取消確認 ")]),_:1}),a(Y,{style:{"font-size":"15px"}},{default:t(()=>[n(" 確定要取消報名嗎？ ")]),_:1}),a(q,null,{default:t(()=>[a(G),a(_,{color:"blue-grey-darken-1",variant:"outlined",size:"small",text:"",onClick:H},{default:t(()=>[n(" 取消 ")]),_:1}),a(_,{color:"red-darken-3",variant:"outlined",size:"small",text:"",onClick:ne},{default:t(()=>[n(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};typeof ee=="function"&&ee(te);const De=fe(te,[["__scopeId","data-v-b20c62a2"]]);export{De as default};
