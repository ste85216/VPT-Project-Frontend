import{_ as ce,l as ue,i as fe,r as I,n as pe,o as u,b as M,d as e,w as a,C as T,F as B,h as C,g as o,V as v,ay as E,e as P,q as g,bk as X,z as k,f as Y,s as V,y as L,B as R,aO as O,J as m,t as r,aL as G,D as me,ax as Z,p as _e,k as ve}from"./index-CF1RYFcj.js";import{b as ee}from"./route-block-B_A1xBdJ.js";import{V as f,a as s}from"./VRow-wgoWGFgv.js";import{V as ae}from"./VDivider-DeOI2aEs.js";const F=D=>(_e("data-v-24dd60b8"),D=D(),ve(),D),ge={class:"opacity-90 mb-4"},ke=F(()=>C("br",null,null,-1)),ye=F(()=>C("br",null,null,-1)),xe=F(()=>C("br",null,null,-1)),we=F(()=>C("br",null,null,-1)),le={__name:"enrollment",setup(D){const{mdAndUp:S}=ue(),{api:te,apiAuth:N}=me(),y=fe(),b=I([]),$=I({open:!1}),i=I({open:!1,id:null,male:0,female:0,nopreference:0}),h=I({open:!1,id:null}),U=t=>!t||!t.v_id?"未知場地":t.v_id.name||"未知場地",H=t=>t?new Date(t).toLocaleDateString("zh-TW"):"未知日期",A=async()=>{var t,n;try{const{data:l}=await N.get("/enrollment");if(Array.isArray(l.result))b.value=l.result.sort((p,d)=>{const _=new Date(p.s_id.date),c=new Date(d.s_id.date);if(_<c)return-1;if(_>c)return 1;const x=p.s_id.time.split("-")[0],w=d.s_id.time.split("-")[0];return x.localeCompare(w)});else throw console.error("Unexpected data format:",l),new Error("資料格式錯誤")}catch(l){console.error("Error loading enrollments:",l),y({text:((n=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:n.message)||l.message||"無法加載報名資料",snackbarProps:{color:"red-lighten-1"}})}},j=t=>{const n=[];return t.male>0&&n.push(`男${t.male}人`),t.female>0&&n.push(`女${t.female}人`),t.nopreference>0&&n.push(`不限${t.nopreference}人`),n.join(" ")},oe=t=>{$.value={open:!0}},se=()=>{$.value.open=!1},q=t=>{i.value={open:!0,id:t._id,male:t.male||0,female:t.female||0,nopreference:t.nopreference||0,originalMale:t.male||0,originalFemale:t.female||0,originalNopreference:t.nopreference||0,session:t.s_id,showMale:t.s_id.male>0,showFemale:t.s_id.female>0,showNopreference:t.s_id.nopreference>0,enrollment:t}},J=()=>{i.value.open=!1},ne=async()=>{try{const t=i.value.showMale?parseInt(i.value.male):0,n=i.value.showFemale?parseInt(i.value.female):0,l=i.value.showNopreference?parseInt(i.value.nopreference):0,p=i.value.originalMale,d=i.value.originalFemale,_=i.value.originalNopreference,c=i.value.session,x=t-p,w=n-d,re=l-_;if(c.nopreference>0){if(x+w+re>c.nopreference)throw new Error(`超過可用名額。當前剩餘 ${c.nopreference} 個名額。`)}else if(x>c.male||w>c.female)throw new Error(`超過可用名額。當前剩餘男 ${c.male} 名，女 ${c.female} 名。`);const z={};i.value.showMale&&(z.male=t),i.value.showFemale&&(z.female=n),i.value.showNopreference&&(z.nopreference=l),await N.patch(`/enrollment/${i.value.id}`,z),y({text:"報名更新成功",snackbarProps:{color:"teal-darken-1"}}),J(),A()}catch(t){y({text:(t==null?void 0:t.message)||"更新失敗",snackbarProps:{color:"red-lighten-1"}})}},W=t=>{h.value={open:!0,id:t}},K=()=>{h.value.open=!1},de=async()=>{var t,n;try{const{data:l}=await te.get("/session");Array.isArray(l.result)?console.log("Sessions reloaded:",l.result):console.error("Unexpected data format:",l)}catch(l){console.error("Error loading sessions:",l),y({text:((n=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:n.message)||"無法加載場次資料",snackbarProps:{color:"red-lighten-1"}})}},ie=async()=>{var t,n;try{const l=await N.delete(`/enrollment/${h.value.id}`);console.log("Delete response:",l.data),y({text:"報名刪除成功",snackbarProps:{color:"teal-darken-1"}}),K(),await A(),await de()}catch(l){console.error("Delete error:",l),y({text:((n=(t=l==null?void 0:l.response)==null?void 0:t.data)==null?void 0:n.message)||l.message||"刪除失敗",snackbarProps:{color:"red-lighten-1"}})}},Q=t=>{const n=t.s_id,l=U(n),[p,d]=n.time.split("-"),_=new Date(n.date);_.setHours(parseInt(p.split(":")[0]),parseInt(p.split(":")[1]));const c=new Date(n.date);c.setHours(parseInt(d.split(":")[0]),parseInt(d.split(":")[1]));const x=`網高: ${n.netheight}
程度: ${n.level}
費用: ${n.fee}/人
備註: ${n.note||"無"}`,w=`https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(`排球場次 - ${l}`)}&dates=${_.toISOString().replace(/-|:|\.\d\d\d/g,"")}/${c.toISOString().replace(/-|:|\.\d\d\d/g,"")}&details=${encodeURIComponent(x)}&location=${encodeURIComponent(l)}`;window.open(w,"_blank")};return pe(()=>{A()}),(t,n)=>(u(),M(B,null,[e(f,{class:"mt-4"},{default:a(()=>[e(s,{cols:"12",class:"pt-0"},{default:a(()=>[e(f,{align:"center"},{default:a(()=>[e(s,{cols:"12",sm:""},{default:a(()=>[C("h3",ge,[o(" 報名紀錄 "),e(v,{icon:"mdi-information-outline",color:"grey-darken-1",size:"x-small",class:"pb-1",onClick:oe})])]),_:1}),e(E),e(s,{cols:"1"})]),_:1})]),_:1}),e(s,{class:"pt-0 pb-2"},{default:a(()=>[e(ae)]),_:1}),P(S)?(u(),g(s,{key:0,cols:"12"},{default:a(()=>[e(f,{class:"mb-4"},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:a(()=>[e(s,{cols:"2"},{default:a(()=>[o(" 球場 ")]),_:1}),e(s,{cols:"2"},{default:a(()=>[o(" 日期 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 時段 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 網高 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 程度 ")]),_:1}),e(s,{cols:"2"},{default:a(()=>[o(" 報名人數 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 費用 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 備註 ")]),_:1}),e(s,{cols:"1"},{default:a(()=>[o(" 操作 ")]),_:1})]),_:1})]),_:1})]),_:1}),b.value.length===0?(u(),g(X,{key:0,class:"opacity-80 text-center"},{default:a(()=>[o(" 目前您沒有報名任何場次 ")]),_:1})):k("",!0),(u(!0),M(B,null,Y(b.value,(l,p)=>(u(),g(V,{key:l._id,elevation:"0",class:"pa-4 py-8 post-card",style:Z({backgroundColor:p%2===0?"#ECEFF1":"#f0f0f080"})},{default:a(()=>[e(f,null,{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:a(()=>[e(s,{cols:"2"},{default:a(()=>[o(r(U(l.s_id)),1)]),_:2},1024),e(s,{cols:"2"},{default:a(()=>{var d;return[o(r(H((d=l.s_id)==null?void 0:d.date)),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(r(((d=l.s_id)==null?void 0:d.time)||"未知時段"),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(r(((d=l.s_id)==null?void 0:d.netheight)||"未知網高"),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(r(((d=l.s_id)==null?void 0:d.level)||"未知程度"),1)]}),_:2},1024),e(s,{cols:"2"},{default:a(()=>[o(r(j(l)),1)]),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(r(((d=l.s_id)==null?void 0:d.fee)===0?"免費":`$${l.s_id.fee}/人`),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>{var d;return[o(r(((d=l.s_id)==null?void 0:d.note)||"無"),1)]}),_:2},1024),e(s,{cols:"1"},{default:a(()=>[e(m,{size:"x-small",color:"blue-darken-1",variant:"outlined",onClick:d=>Q(l)},{default:a(()=>[e(v,{icon:"mdi-clock-out"})]),_:2},1032,["onClick"]),ke,e(m,{size:"x-small",color:"teal-darken-1",variant:"outlined",class:"mt-1",onClick:d=>q(l)},{default:a(()=>[e(v,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),e(m,{size:"x-small",color:"red-darken-3",variant:"outlined",class:"mt-1",onClick:d=>W(l._id)},{default:a(()=>[e(v,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1})):k("",!0),P(S)?k("",!0):(u(),g(s,{key:1,cols:"12"},{default:a(()=>[e(f,{class:"mb-4"},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(f,{class:"px-4 text-center",style:{"font-size":"15px"}},{default:a(()=>[e(s,null,{default:a(()=>[o("球場")]),_:1}),e(s,null,{default:a(()=>[o("日期/時段")]),_:1}),e(s,{cols:"3"},{default:a(()=>[o(" 操作 ")]),_:1})]),_:1})]),_:1})]),_:1}),b.value.length===0?(u(),g(X,{key:0,align:"center",class:"opacity-80"},{default:a(()=>[o(" 目前您沒有報名任何場次 ")]),_:1})):k("",!0),(u(!0),M(B,null,Y(b.value,(l,p)=>(u(),g(V,{key:l._id,elevation:"0",class:"pa-4 py-8 post-card",style:Z({backgroundColor:p%2===0?"#ECEFF1":"#f0f0f080"})},{default:a(()=>[e(f,null,{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(f,{class:"align-center text-center text-subtitle-2 text-blue-grey-darken-2"},{default:a(()=>[e(s,null,{default:a(()=>[o(r(U(l.s_id)),1)]),_:2},1024),e(s,null,{default:a(()=>{var d,_;return[o(r(H((d=l.s_id)==null?void 0:d.date))+" ",1),ye,o(" "+r(((_=l.s_id)==null?void 0:_.time)||"未知時段"),1)]}),_:2},1024),e(s,{cols:"3"},{default:a(()=>[e(m,{size:"x-small",color:"blue-darken-1",variant:"outlined",onClick:d=>Q(l)},{default:a(()=>[e(v,{icon:"mdi-clock-out"})]),_:2},1032,["onClick"]),xe,e(m,{size:"x-small",color:"teal-darken-1",variant:"outlined",class:"mt-2",onClick:d=>q(l)},{default:a(()=>[e(v,{icon:"mdi-pen"})]),_:2},1032,["onClick"]),we,e(m,{size:"x-small",color:"red-darken-3",variant:"outlined",class:"mt-2",onClick:d=>W(l._id)},{default:a(()=>[e(v,{icon:"mdi-delete"})]),_:2},1032,["onClick"])]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1024)]),_:2},1032,["style"]))),128))]),_:1}))]),_:1}),e(T,{modelValue:$.value.open,"onUpdate:modelValue":n[0]||(n[0]=l=>$.value.open=l),"max-width":"320px"},{default:a(()=>[e(V,{class:"px-2 py-5 rounded-lg"},{default:a(()=>[e(L,{class:"ps-6",style:{"font-size":"16px"}},{default:a(()=>[o(" 操作說明 ")]),_:1}),e(R,{class:"pb-0"},{default:a(()=>[e(f,{style:{"font-size":"15px"}},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>[e(v,{icon:"mdi-clock-out",color:"blue-darken-1",size:"small"}),o(" : 將場次加入Google 行事曆按鈕 ")]),_:1}),e(s,{cols:"12"},{default:a(()=>[e(v,{icon:"mdi-pen",color:"teal-darken-1",size:"small"}),o(" : 編輯報名人數按鈕 ")]),_:1}),e(s,{cols:"12"},{default:a(()=>[e(v,{icon:"mdi-delete",color:"red-darken-3",size:"small"}),o(" : 取消報名按鈕 ")]),_:1})]),_:1})]),_:1}),e(O,null,{default:a(()=>[e(E),e(m,{color:"teal-lighten-1",variant:"outlined",size:"small",onClick:se},{default:a(()=>[o(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(T,{modelValue:i.value.open,"onUpdate:modelValue":n[4]||(n[4]=l=>i.value.open=l),"max-width":"320px"},{default:a(()=>[e(V,{class:"px-2 py-5 rounded-lg"},{default:a(()=>[e(L,{class:"ps-6",style:{"font-size":"16px"}},{default:a(()=>[o(" 編輯報名 ")]),_:1}),e(R,{class:"pb-0"},{default:a(()=>[P(S)?k("",!0):(u(),g(f,{key:0,class:"mb-4 md-down-dialog-text"},{default:a(()=>[e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 網高: "+r(((l=i.value.session)==null?void 0:l.netheight)||"未知"),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 程度: "+r(((l=i.value.session)==null?void 0:l.level)||"未知"),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 價錢: "+r(((l=i.value.session)==null?void 0:l.fee)===0?"免費":`$${i.value.session.fee}/人`),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>{var l;return[o(" 備註: "+r(((l=i.value.session)==null?void 0:l.note)||"無"),1)]}),_:1}),e(s,{cols:"12"},{default:a(()=>[o(" 你已報名: "+r(j(i.value.enrollment)),1)]),_:1}),e(ae,{class:"mt-2 mb-5"})]),_:1})),i.value.showMale?(u(),g(G,{key:1,modelValue:i.value.male,"onUpdate:modelValue":n[1]||(n[1]=l=>i.value.male=l),label:"男生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0),i.value.showFemale?(u(),g(G,{key:2,modelValue:i.value.female,"onUpdate:modelValue":n[2]||(n[2]=l=>i.value.female=l),label:"女生人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0),i.value.showNopreference?(u(),g(G,{key:3,modelValue:i.value.nopreference,"onUpdate:modelValue":n[3]||(n[3]=l=>i.value.nopreference=l),label:"不限性別人數",variant:"outlined",density:"compact",type:"number",min:"0"},null,8,["modelValue"])):k("",!0)]),_:1}),e(O,{class:"px-5"},{default:a(()=>[e(E),e(m,{color:"red-darken-1",variant:"outlined",size:"small",onClick:J},{default:a(()=>[o(" 取消 ")]),_:1}),e(m,{color:"teal-lighten-1",variant:"outlined",size:"small",onClick:ne},{default:a(()=>[o(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),e(T,{modelValue:h.value.open,"onUpdate:modelValue":n[5]||(n[5]=l=>h.value.open=l),"max-width":"300px"},{default:a(()=>[e(V,{class:"py-4 px-3"},{default:a(()=>[e(L,{style:{"font-size":"16px"}},{default:a(()=>[o(" 取消確認 ")]),_:1}),e(R,{style:{"font-size":"15px"}},{default:a(()=>[o(" 確定要取消報名嗎？ ")]),_:1}),e(O,null,{default:a(()=>[e(E),e(m,{color:"blue-grey-darken-1",variant:"outlined",size:"small",text:"",onClick:K},{default:a(()=>[o(" 取消 ")]),_:1}),e(m,{color:"red-darken-3",variant:"outlined",size:"small",text:"",onClick:ie},{default:a(()=>[o(" 確認 ")]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])],64))}};typeof ee=="function"&&ee(le);const De=ce(le,[["__scopeId","data-v-24dd60b8"]]);export{De as default};
